<!DOCTYPE html>
<html lang="es">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Bloquear conexiones HTTPS con DNS y Firewall &middot; Tech Monkey
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/blackdoc.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=EB+Garamond">
  <link href="https://fonts.googleapis.com/css?family=Bree+Serif|Coustard" rel="stylesheet">
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Tech Monkey
        </a>
      </h1>
      <p class="lead">An Accidental Engineer • #Linux #DevOps #Programmer #Infosec</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">Acerca de</a>
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

      <hr>
      <a class="sidebar-nav-item" href="https://github.com/jahrmando/blackdoc">Repositorios</a>
    </nav>

    <p>&copy; 2017. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Bloquear conexiones HTTPS con DNS y Firewall</h1>
  <span class="post-date">30 Jan 2014</span>
  <p>En este caso ejemplificaremos el bloqueo del sitio <strong>facebook.com</strong>. Existen muchas formas validas de bloquear conexiones https, en este caso explicaremos este método.</p>

<p>En teoría este método consiste en otorgarle al cliente cuando solicite la dirección facebook.com una IP no válida ó bloqueada, con esto rechazaremos las conexiones hacia ese dominio.</p>

<p>Pero si lo que queremos es controlar quienes pueden acceder, podemos controlar que IP publica válida resolver para el dominio ya que el servicio facebook.com posee un balanceo de carga de peticiones, esto significa que cada que hacemos una petición al dominio nos es otorgado diferentes IPs, esto nos hace casi imposible bloquear efectivamente a facebook.com desde el firewall.</p>

<p>Este método requiere que tengamos en DNS interno (BIND) en la red LAN previamente configurado. En este ejemplo nuestro servidor tiene asignado la IP <strong>192.168.0.1</strong></p>

<p>Que los clientes tengan configurado nuestra dirección IP del DNS interno (192.168.0.1) para que resuelvan IPs en nuestro servidor. Si tienes un servicio de DHCP es necesario agregar la IP <strong>192.168.0.1</strong> como DNS.</p>

<p>El servicio <strong>shorewall</strong> previamente configurado, pero bastaría con bloquear en su firewall los puertos e IPs que se mencionaran mas adelante.</p>

<h2 id="configurando-en-el-servicio-dns-bind">Configurando en el servicio DNS (Bind)</h2>

<p>Obtenemos una IP válida al servicio facebook.com.</p>

<p>Con el comando <code class="highlighter-rouge">nslookup</code> resolvemos el dominio y la respuesta fue la IP <strong>173.252.110.27</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ nslookup facebook.com
Server:         192.168.0.1
Address:        192.168.0.1#53

Name:   facebook.com
Address: 173.252.110.27
</code></pre>
</div>

<p>Creamos la zona para el dominio facebook.com</p>

<p>En nuestro directorio de configuración de <strong>BIND</strong> creamos el siguiente archivo de configuración de la zona y este resolverá todas las peticiones con la IP <em>173.252.110.27</em></p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim facebook.zone                                     
$TTL 1W
@               IN SOA  dns   root      (
    2014012401  ; serial  (year, month, day, count)
    2W          ; refresh
    1H          ; retry
    6W          ; expiry
    1W          ; minimum
    )

                 IN NS         dns
                 IN MX     10  mailserver

@                IN A          173.252.110.27
*                IN A          173.252.110.27
</code></pre>
</div>

<p>Habilitamos la zona facebook.com</p>

<p>En nuestra configuración de <strong>BIND</strong> habilitamos la zona de la siguiente manera.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim named.conf
## Zona falsa
zone "facebook.com" IN {
        type master;
        file "facebook.zone";
        allow-update { none; };
};
</code></pre>
</div>

<p>Reiniciamos el servicio para aplicar cambios.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ service named restart
</code></pre>
</div>

<h2 id="bloqueando-en-el-firewall">Bloqueando en el firewall</h2>

<p>Suponiendo que nuestro servicio shorewall tenemos las zonas de red <strong><em>lan</em></strong> que hace referencia obviamente a nuestra red LAN y que la zona <strong><em>net</em></strong> hace referencia a la red Internet, teniendo esto en cuenta realizamos la siguiente configuración.</p>

<p>En nuestro archivo de reglas de shorewall <code class="highlighter-rouge">/etc/shorewall/rules</code> configuramos la siguiente regla según sea el caso que deseemos aplicar:</p>

<p>Si queremos bloquear las peticiones de la red LAN.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/shorewall/rules
REJECT  lan  net:173.252.110.27  tcp  443
</code></pre>
</div>

<p>Determinando un rango de IPs bloqueadas.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/shorewall/rules
REJECT  lan:192.168.0.5-192.168.0.29  net:173.252.110.27  tcp  443
</code></pre>
</div>

<p>Reiniciamos el servicio para aplicar cambios.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ service shorewall restart
</code></pre>
</div>

<p>Como configuración extra podríamos agregar una regla al firewall que solo permita para la red LAN el puerto 53 TCP/UDP peticiones hacia la IP de nuestro servidor DNS interno. Con esto evitaríamos que un astuto quiera usar un servicio DNS ajeno al nuestro.</p>

</div>

<div class="related">
  <h2>Quizas te interese</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2015/12/04/the-netflix-tech-blog-an%C3%A1lisis-del-rendimiento/">
            Análisis del rendimiento de Linux en 60 Segundos
            <small>04 Dec 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/03/27/sitio-en-mantenimiento-con-nginx/">
            Manejar un estado de Mantemiento WebSite con NGINX
            <small>27 Mar 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/03/13/excelente-cheat-sheet-para-principiantes-de-vim/">
            Excelente cheat sheet de VIM
            <small>13 Mar 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
