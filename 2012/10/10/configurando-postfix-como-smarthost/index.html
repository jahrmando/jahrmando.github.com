<!DOCTYPE html>
<html lang="es">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Configurando postfix como smarthost  &middot; Tech Monkey
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/blackdoc.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=EB+Garamond">
  <link href="https://fonts.googleapis.com/css?family=Bree+Serif|Coustard" rel="stylesheet">
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Tech Monkey
        </a>
      </h1>
      <p class="lead">An Accidental Engineer • #Linux #DevOps #Programmer #Infosec</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">Acerca de</a>
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

      <hr>
      <a class="sidebar-nav-item" href="https://github.com/jahrmando/blackdoc">Repositorios</a>
    </nav>

    <p>&copy; 2017. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Configurando postfix como smarthost </h1>
  <span class="post-date">10 Oct 2012</span>
  <p>Configuremos el servicio postfix para que actué como smarthost y así poder enviar correos desde la terminal. En este ejemplo usare mi cuenta gmail. Recordar en este howto es para usar conexiones ssl que normalmente usa el puerto 465 smtp.</p>

<p>Instalamos los paquetes necesarios</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ yum install postfix stunnel -y
</code></pre>
</div>

<p>Preparando stunnel</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ openssl genrsa -out privkey.pem 2048
$ openssl req -new -x509 -key privkey.pem -out cacert.pem -days 1095
$ cat privkey.pem cacert.pem &gt; /etc/stunnel/stunnel.pem
$ chmod 0400 /etc/stunnel/stunnel.pem
$ mkdir /var/run/stunnel
$ chown nobody:nobody /var/run/stunnel
</code></pre>
</div>

<p>Aplicando los parámetros de configuración</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/stunnel/stunnel.conf 
cert = /etc/stunnel/stunnel.pem
chroot = /var/run/stunnel/
pid = /stunnel.pid
setuid = nobody
setgid = nobody
[smtp-tls-wrapper]
accept = 11125
client = yes
connect = smtp.gmail.com:465
</code></pre>
</div>

<p>Lanzando en inicio de sistema stunnel</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/rc.local
# Agregamos siguiente linea Stunnel
/usr/bin/stunnel
</code></pre>
</div>

<p>Probando stunnel (Intentar una conexión local y revisar que pase por nuestro túnel)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ stunnel
$ telnet localhost 11125
Trying 127.0.0.1…
Connected to localhost.
Escape character is ‘^]’.
220 mx.google.com ESMTP y66sm40234408yhi.10
</code></pre>
</div>

<p>Mas configuraciones</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/hosts.allow
smtp-tls-wrapper: 127.0.0.1
</code></pre>
</div>

<p>Configuracion de credenciales</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/postfix/relay_passwd
[127.0.0.1]:11125    user@gmail.com:miPassWord 
$ postmap hash:/etc/postfix/relay_passwd
</code></pre>
</div>

<p>Crear los certificados de gmail (copy, paste)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim Thawte_Premium_Server_CA.pem
——-BEGIN CERTIFICATE——-
MIIDJzCCApCgAwIBAgIBATANBgkqhkiG9w0BAQQFADCBzjELMAkGA1UEBhMCWkExFTATBgNVBAgT
DFdlc3Rlcm4gQ2FwZTESMBAGA1UEBxMJQ2FwZSBUb3duMR0wGwYDVQQKExRUaGF3dGUgQ29uc3Vs
dGluZyBjYzEoMCYGA1UECxMfQ2VydGlmaWNhdGlvbiBTZXJ2aWNlcyBEaXZpc2lvbjEhMB8GA1UE
AxMYVGhhd3RlIFByZW1pdW0gU2VydmVyIENBMSgwJgYJKoZIhvcNAQkBFhlwcmVtaXVtLXNlcnZl
ckB0aGF3dGUuY29tMB4XDTk2MDgwMTAwMDAwMFoXDTIwMTIzMTIzNTk1OVowgc4xCzAJBgNVBAYT
AlpBMRUwEwYDVQQIEwxXZXN0ZXJuIENhcGUxEjAQBgNVBAcTCUNhcGUgVG93bjEdMBsGA1UEChMU
VGhhd3RlIENvbnN1bHRpbmcgY2MxKDAmBgNVBAsTH0NlcnRpZmljYXRpb24gU2VydmljZXMgRGl2
aXNpb24xITAfBgNVBAMTGFRoYXd0ZSBQcmVtaXVtIFNlcnZlciBDQTEoMCYGCSqGSIb3DQEJARYZ
cHJlbWl1bS1zZXJ2ZXJAdGhhd3RlLmNvbTCBnzANBgkqhkiG9w0BAQEFAAOBjQAwgYkCgYEA0jY2
aovXwlue2oFBYo847kkEVdbQ7xwblRZH7xhINTpS9CtqBo87L+pW46+GjZ4X9560ZXUCTe/LCaIh
Udib0GfQug2SBhRz1JPLlyoAnFxODLz6FVL88kRu2hFKbgifLy3j+ao6hnO2RlNYyIkFvYMRuHM/
qgeN9EJN50CdHDcCAwEAAaMTMBEwDwYDVR0TAQH/BAUwAwEB/zANBgkqhkiG9w0BAQQFAAOBgQAm
SCwWwlj66BZ0DKqqX1Q/8tfJeGBeXm43YyJ3Nn6yF8Q0ufUIhfzJATj/Tb7yFkJD57taRvvBxhEf
8UqwKEbJw8RCfbz6q1lu1bdRiBHjpIUZa4JMpAwSremkrj/xw0llmozFyD4lt5SZu5IycQfwhl7t
UCemDaYj+bvLpgcUQg==
——-END CERTIFICATE——-
$ vim Equifax_Secure_CA.pem
——-BEGIN CERTIFICATE——-
MIIDIDCCAomgAwIBAgIENd70zzANBgkqhkiG9w0BAQUFADBOMQswCQYDVQQGEwJVUzEQMA4GA1UE
ChMHRXF1aWZheDEtMCsGA1UECxMkRXF1aWZheCBTZWN1cmUgQ2VydGlmaWNhdGUgQXV0aG9yaXR5
MB4XDTk4MDgyMjE2NDE1MVoXDTE4MDgyMjE2NDE1MVowTjELMAkGA1UEBhMCVVMxEDAOBgNVBAoT
B0VxdWlmYXgxLTArBgNVBAsTJEVxdWlmYXggU2VjdXJlIENlcnRpZmljYXRlIEF1dGhvcml0eTCB
nzANBgkqhkiG9w0BAQEFAAOBjQAwgYkCgYEAwV2xWGcIYu6gmi0fCG2RFGiYCh7+2gRvE4RiIcPR
fM6fBeC4AfBONOziipUEZKzxa1NfBbPLZ4C/QgKO/t0BCezhABRP/PvwDN1Dulsr4R+AcJkVV5MW
8Q+XarfCaCMczE1ZMKxRHjuvK9buY0V7xdlfUNLjUA86iOe/FP3gx7kCAwEAAaOCAQkwggEFMHAG
A1UdHwRpMGcwZaBjoGGkXzBdMQswCQYDVQQGEwJVUzEQMA4GA1UEChMHRXF1aWZheDEtMCsGA1UE
CxMkRXF1aWZheCBTZWN1cmUgQ2VydGlmaWNhdGUgQXV0aG9yaXR5MQ0wCwYDVQQDEwRDUkwxMBoG
A1UdEAQTMBGBDzIwMTgwODIyMTY0MTUxWjALBgNVHQ8EBAMCAQYwHwYDVR0jBBgwFoAUSOZo+SvS
spXXR9gjIBBPM5iQn9QwHQYDVR0OBBYEFEjmaPkr0rKV10fYIyAQTzOYkJ/UMAwGA1UdEwQFMAMB
Af8wGgYJKoZIhvZ9B0EABA0wCxsFVjMuMGMDAgbAMA0GCSqGSIb3DQEBBQUAA4GBAFjOKer89961
zgK5F7WF0bnj4JXMJTENAKaSbn+2kmOeUJXRmm/kEd5jhW6Y7qj/WsjTVbJmcVfewCHrPSqnI0kB
BIZCe/zuf6IWUrVnZ9NA2zsmWLIodz2uFHdh1voqZiegDfqnc1zqcPGUIWVEX/r87yloqaKHee95
70+sB3c4
——-END CERTIFICATE——-
</code></pre>
</div>

<p>Importando los certificados</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ mkdir /etc/postfix/ssl
$ touch /etc/postfix/ssl/cacert.pem
$ cat Equifax_Secure_CA.pem &gt; /etc/postfix/ssl/cacert.pem
$ cat Thawte_Premium_Server_CA.pem &gt; /etc/postfix/ssl/cacert.pem
</code></pre>
</div>

<p>Configurando postfix</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/postfix/main.cf
inet_protocols = ipv4
relayhost = [127.0.0.1]:11125
### SASL
smtp_sasl_password_maps = hash:/etc/postfix/relay_passwd
smtp_sasl_auth_enable = yes
smtp_sasl_security_options = noanonymous
### TLS
smtp_use_tls = yes
smtp_sasl_mechanism_filter = plain, login
smtp_tls_CAfile = /etc/postfix/ssl/cacert.pem
smtp_tls_CApath = /etc/postfix/ssl
smtp_sasl_tls_security_options = noanonymous
smtp_tls_session_cache_timeout = 3600s
</code></pre>
</div>

<p>Configurando los servicios:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ systemctl stop sendmail.service
$ systemctl disable sendmail.service
$ alternatives --config mta
There are 2 programs which provide ‘mta’.
      Selection    Command
    ———————————————————————-
    *+ 1           /usr/sbin/sendmail.sendmail
       2           /usr/sbin/sendmail.postfix
       Enter to keep the current selection[+], or type selection number: 2 
$ systemctl start postfix.service
$ chkconfig postfix on
</code></pre>
</div>

<p>Probando todo</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ mail -s test prueba@correo.com.mx &lt; /dev/null
Null message body; hope that’s ok
</code></pre>
</div>

<blockquote>
  <p>Esta configuración también la he probado en CentOS 6.2, solo que la configuración de servicios lo hacemos por medio de chkconfig</p>
</blockquote>

</div>

<div class="related">
  <h2>Quizas te interese</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2017/02/20/aplicaci%C3%B3n-de-parches-en-vmware-esxi-5x/">
            Aplicación de parches en VMware ESXi 5.x
            <small>20 Feb 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/12/09/clonaci%C3%B3n-y-migraci%C3%B3n-en-tiempo-real-live/">
            Clonación y migración en tiempo real de instancias virtuales Qemu/KVM
            <small>09 Dec 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/12/04/the-netflix-tech-blog-an%C3%A1lisis-del-rendimiento/">
            Análisis del rendimiento de Linux en 60 Segundos
            <small>04 Dec 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
