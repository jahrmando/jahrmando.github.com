<!DOCTYPE html>
<html lang="es">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Configuración de Django en CentOS 6 &middot; Tech Monkey
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/blackdoc.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=EB+Garamond">
  <link href="https://fonts.googleapis.com/css?family=Bree+Serif|Coustard" rel="stylesheet">
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Tech Monkey
        </a>
      </h1>
      <p class="lead">An Accidental Engineer • #Linux #DevOps #Programmer #Infosec</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">Acerca de</a>
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

      <hr>
      <a class="sidebar-nav-item" href="https://github.com/jahrmando/blackdoc">Repositorios</a>
    </nav>

    <p>&copy; 2017. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Configuración de Django en CentOS 6</h1>
  <span class="post-date">16 Oct 2013</span>
  <p>Stack: NGINX, GUNICORN, VIRTUALENV y SUPERVISOR</p>

<p>PRE INSTALACION</p>

<p>Instalamos los siguientes paquetes para compilaciones. Es de utilidad en algunos paquetes que instalemos dentro de PIP y los archivos de desarrollo de python.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ yum install gcc make python-devel
</code></pre>
</div>

<p>PIP, VIRTUALENV</p>

<p>Instalamos PIP desde los repositorios EPEL</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ yum -y install python-pip --enablerepo epel
</code></pre>
</div>

<p>Instalamos virtualenvwrapper desde PIP, este instalara como dependencia a virtualenv.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ pip install virtualenvwrapper
</code></pre>
</div>

<p>Creamos nuestras variables de sistema para virtualenv y lo alojamos en el archivo de configuración bash del usuario unix.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ echo 'export WORKON_HOME=/opt/virtualenvs' &gt;&gt; $HOME/.bashrc
$ echo 'export VIRTUALENVWRAPPER_HOOK_DIR=$WORKON_HOME/hooks' &gt;&gt; $HOME/.bashrc
$ echo 'source /usr/bin/virtualenvwrapper.sh' &gt;&gt; $HOME/.bashrc
</code></pre>
</div>

<p>Creamos la carpeta para HOOKs.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ mkdir /opt/virtualenvs/hooks
</code></pre>
</div>

<p>Creamos un entorno virtual de prueba</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ mkvirtualenv projectwebapp
</code></pre>
</div>

<p>Salimos del entorno virtual</p>

<div class="highlighter-rouge"><pre class="highlight"><code>(projectwebapp)$ deactivate
</code></pre>
</div>

<p>DJANGO</p>

<p>Creamos una carpeta donde alojaremos nuestros proyectos Django y nos cambiamos al directorio.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ mkdir /home/www/
$ cd /home/www
</code></pre>
</div>

<p>Habilitamos el entorno virtual para el proyecto</p>

<div class="highlighter-rouge"><pre class="highlight"><code>www $ workon projectwebapp
</code></pre>
</div>

<p>Instalamos Django desde PIP y creamos un proyecto Django</p>

<div class="highlighter-rouge"><pre class="highlight"><code>(projectwebapp) www $ pip install django
(projectwebapp) www $ django-admin.py startproject projectwebapp
(projectwebapp) www $ cd projectwebapp/
</code></pre>
</div>

<p>Iniciamos el servicio http de Django nativo para probar que todo este funcional hasta este punto.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>(projectwebapp) projectwebapp $ python manage.py runserver
Validating models...
0 errors found
October 15, 2013 - 13:54:33
Django version 1.5.4, using settings 'projectwebapp.settings'
Development server is running at http://127.0.0.1:8000/
Quit the server with CONTROL-C.
</code></pre>
</div>

<p>Detenemos el servicio Django con el atajo de teclado <code class="highlighter-rouge">CONTROL-C</code>.</p>

<p>GUNICORN. Python WSGI HTTP Server</p>

<p>Instalamos gunicorn via PIP dentro del entorno virtual del proyecto. También se instala setproctitle que nos permite renombrar el proceso gunicorn por el nombre del proyecto Django.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>(projectwebapp) projectwebapp $ pip install gunicorn setproctitle
</code></pre>
</div>

<p>Estando en la carpeta del proyecto iniciamos el proyecto con gunicorn usando el modulo WSGI del proyecto Django.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>(projectwebapp) projectwebapp $ gunicorn projectwebapp.wsgi
2013-10-15 15:05:17 [13252] [INFO] Starting gunicorn 18.0
2013-10-15 15:05:17 [13252] [INFO] Listening at: http://127.0.0.1:8000 (13252)
2013-10-15 15:05:17 [13252] [INFO] Using worker: sync
2013-10-15 15:05:17 [13257] [INFO] Booting worker with pid: 13257
</code></pre>
</div>

<p>Detenemos el servicio Gunicorn con el atajo de teclado CONTROL-C.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>^C2013-10-15 15:05:33 [13257] [INFO] Worker exiting (pid: 13257)
2013-10-15 15:05:33 [13252] [INFO] Handling signal: int
2013-10-15 15:05:33 [13252] [INFO] Shutting down: Master
</code></pre>
</div>

<p>Salimos del entorno virtual</p>

<div class="highlighter-rouge"><pre class="highlight"><code>(projectwebapp) projectwebapp $ deactive
</code></pre>
</div>

<p>Creamos el directorio donde alojaremos el script bash que nos iniciara el Gunicorn, debemos tener creado antes el directorio <code class="highlighter-rouge">/opt/gunicorn/</code> para alojar mas proyectos.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ mkdir /opt/gunicorn/projectwebapp/
</code></pre>
</div>

<p>Creamos y editamos el archivo script para ejecutar el proyecto con gunicorn</p>

<div class="language-sh highlighter-rouge"><pre class="highlight"><code><span class="gp">$ </span>vim /opt/gunicorn/projectwebapp/gunicorn_start.sh
<span class="c">#!/bin/bash</span>

<span class="nv">DJANGODIR</span><span class="o">=</span>/home/www/projectwebapp             <span class="c"># Directorio del proyecto Django</span>
<span class="nv">SOCKFILE</span><span class="o">=</span>/var/run/gunicorn/projectwebapp.sock <span class="c"># Unix socket</span>
<span class="nv">USER</span><span class="o">=</span>nginx                                    <span class="c"># Usuario </span>
<span class="nv">GROUP</span><span class="o">=</span>root                                    <span class="c"># Grupo</span>
<span class="nv">NUM_WORKERS</span><span class="o">=</span>3                                 <span class="c"># Numero de procesos para gunicorn</span>
<span class="nv">DJANGO_SETTINGS_MODULE</span><span class="o">=</span>projectwebapp.settings <span class="c"># Archivo settings del proyecto</span>
<span class="nv">DJANGO_WSGI_MODULE</span><span class="o">=</span>projectwebapp.wsgi         <span class="c"># Modulo WSGI del proyecto</span>

<span class="c"># Activar el entorno virtual</span>
<span class="nb">cd</span> <span class="nv">$DJANGODIR</span>
<span class="nb">source</span> /usr/bin/virtualenvwrapper.sh
workon projectwebapp
<span class="nb">export </span><span class="nv">DJANGO_SETTINGS_MODULE</span><span class="o">=</span><span class="nv">$DJANGO_SETTINGS_MODULE</span>
<span class="nb">export </span><span class="nv">PYTHONPATH</span><span class="o">=</span><span class="nv">$DJANGODIR</span>:<span class="nv">$PYTHONPATH</span>

<span class="c"># Crear el directorio del socket si no existe</span>
<span class="nv">RUNDIR</span><span class="o">=</span><span class="k">$(</span>dirname <span class="nv">$SOCKFILE</span><span class="k">)</span>
<span class="nb">test</span> -d <span class="nv">$RUNDIR</span> <span class="o">||</span> mkdir -p <span class="nv">$RUNDIR</span>

<span class="c"># Iniciar el proyecto Django</span>
<span class="c"># No se usa el modo --daemon ya que este sera manejado por supervisor</span>
<span class="nb">exec </span>gunicorn <span class="k">${</span><span class="nv">DJANGO_WSGI_MODULE</span><span class="k">}</span> <span class="se">\</span>
  --workers <span class="nv">$NUM_WORKERS</span> <span class="se">\</span>
  --user<span class="o">=</span><span class="nv">$USER</span> --group<span class="o">=</span><span class="nv">$GROUP</span> <span class="se">\</span>
  --log-level<span class="o">=</span>debug <span class="se">\</span>
  --bind<span class="o">=</span>unix:<span class="nv">$SOCKFILE</span>
</code></pre>
</div>

<p>Permisos de ejecución</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ chmod u+x /opt/gunicorn/projectwebapp/gunicorn_start.sh
</code></pre>
</div>

<p>Ejecutamos el script para probar el funcionamiento correcto</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ /opt/gunicorn/projectwebapp/gunicorn_start.sh
</code></pre>
</div>

<p>SUPERVISOR</p>

<p>Es un servicio de monitoreo y control de procesos. Instalamos la mas reciente versión de supervisor desde PIP.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ pip install supervisor
</code></pre>
</div>

<p>Creamos el archivo de configuración.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ echo_supervisord_conf &gt; /etc/supervisord.conf
</code></pre>
</div>

<p>Creamos la carpeta de logs.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ mkdir /var/log/supervisor
</code></pre>
</div>

<p>Configuramos los siguientes parámetros.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/supervisord.conf
# Modifique las siguientes configuraciones
[unix_http_server] 
...
file=/var/run/supervisor.sock
...
[supervisord]
...
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid 
umask=022
user=root
...
</code></pre>
</div>

<p>Creamos el script para supervisor que ejecutara el servicio como daemon y auto inicio con el sistema. Este es una adaptación propia basado en el script de <strong><em>Mike McGrath</em></strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/init.d/supervisord
#!/bin/bash
#
# supervisord   This scripts turns supervisord on
#
# chkconfig: - 95 04
#
# processname:  supervisord
# config: /etc/supervisord.conf
#

# source function library
. /etc/rc.d/init.d/functions

RETVAL=0
conffile=${CONFFILE-/etc/supervisord.conf}
user=${USER-root}

start() {
        echo -n $"Starting supervisord: "
        runuser -l ${user} -c "supervisord -c ${conffile}" &amp;&amp; echo_success || echo_failure
        RETVAL=$?
        echo
        [ $RETVAL -eq 0 ] &amp;amp;&amp;amp; touch /var/lock/subsys/supervisord
        }

stop() {
 echo -n $"Stopping supervisord: "
 killproc supervisord
 echo
 [ $RETVAL -eq 0 ] &amp;amp;&amp;amp; rm -f /var/lock/subsys/supervisord
 }

restart() {
 stop
 start
 }

case "$1" in
  start)
 start
 ;;
  stop) 
 stop
 ;;
  restart|force-reload|reload)
 restart
 ;;
  condrestart)
 [ -f /var/lock/subsys/supervisord ] &amp;amp;&amp;amp; restart
 ;;
  status)
 status supervisord
 RETVAL=$?
 ;;
  *)
 echo $"Usage: $0 {start|stop|status|restart|reload|force-reload|condrestart}"
 exit 1
 esac

exit $RETVAL
</code></pre>
</div>

<p>Damos de alta nuestro script como servicio.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ chkconfig --add supervisord
</code></pre>
</div>

<p>Lo agregamos al inicio de sistema con el runrevel por defecto.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ chkconfig supervisord on
</code></pre>
</div>

<p>Iniciamos el servicio.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ service supervisord start
</code></pre>
</div>

<p>Configuramos una instancia de programa agregando nuestro script gunicorn que ejecuta nuestra app Django.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/supervisord.conf
# Agregue este bloque de configuracion segun su proyecto
[program:projectwebapp]
command=/opt/gunicorn/projectwebapp/gunicorn_start.sh
user=root
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/projectwebapp.log
redirect_stderr=True
</code></pre>
</div>

<p>Reiniciamos supervisor</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ service supervisord restart
</code></pre>
</div>

<p>NGINX. HTTP Server</p>

<p>Instalamos la repo NGINX oficial.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ touch /etc/yum.repos.d/nginx.repo
$ vim /etc/yum.repos.d/nginx.repo
[nginx]
name=nginx repo
baseurl=http://nginx.org/packages/centos/6/$basearch/
gpgcheck=0
enabled=1
</code></pre>
</div>

<p>Instalamos nginx, los agregamos al inicio de sistema e iniciamos.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ yum install nginx
$ chkconfig nginx on
$ service nginx start
</code></pre>
</div>

<p>Creamos las carpetas donde alojamos configuración de los sitios.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ mkdir /etc/nginx/sites-available
$ mkdir /etc/nginx/sites-enabled
$ mkdir /var/log/nginx/sites
</code></pre>
</div>

<p>Creamos un respaldo de la configuración global y aplicamos las configuraciones siguientes para el servicio.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.old
$ vim /etc/nginx/nginx.conf
user  nginx;
# Numero de CPUs
worker_processes  2;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
    }

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    ## Optimiza el rendimiento de sendfile al enviar tramas HTTP
    ## en un solo paquete.
    tcp_nopush     on;
    ## Soporte gzip. Reduce la cantidad de datos a transferir
    gzip  on;

    ## Configuracion de buffers
    client_body_buffer_size  1K;
    client_header_buffer_size 1k;
    client_max_body_size 1k;
    large_client_header_buffers 2 1k;

    ## Configuracion de timeouts 
    client_body_timeout   10;
    client_header_timeout 10;
    keepalive_timeout     5 5;
    send_timeout          10;

    include /etc/nginx/conf.d/*.conf;

    ## Directorio de configuracion para vhost's en linea
    include /etc/nginx/sites-enabled/*.conf;
    }
</code></pre>
</div>

<p>Agregamos la ip 127.0.0.1 para escucha solo local del sitio default, también podemos borrar este archivo si quieren des-habilitar completamente.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/nginx/conf.d/default.conf 
server {
    listen       127.0.0.1:80;
    
    Creamos y configuramos el sitio para nuestro proyecto projectwebapp de la siguiente manera. 

$ vim /etc/nginx/sites-available/projectwebapp.conf
# Configuracion NGINX para projectwebapp
#
upstream projectwebapp {
  server unix:/var/run/gunicorn/projectwebapp.sock fail_timeout=0;
  }

server {
    listen       10.0.0.23:80;

    # Configuracion HTTPS
    # listen       10.0.0.23:443 ssl;

    server_name  app.example.com;
    server_tokens off;

    access_log  /var/log/nginx/sites/projectwebapp.access.log;
    error_log  /var/log/nginx/sites/projectwebapp.error.log;

    # Configuracion HTTPS
    #ssl_certificate     /etc/nginx/ssl/server.crt;
    #ssl_certificate_key /etc/nginx/ssl/server.key;
    #ssl_prefer_server_ciphers on;
    #ssl_protocols       SSLv3 TLSv1 TLSv1.1 TLSv1.2;
    #ssl_session_cache shared:SSL:2m;
    #ssl_ciphers RC4:HIGH:!MD5:!aNULL:!DH:!EDH;

    # HTTP Strict Transport Security (HSTS). Configuracion HTTPS
    #add_header Strict-Transport-Security max-age=31536000;

    # Limite subidas de archivos.
    client_max_body_size 1M;

    # Acceso solo por medio del dominio
    if ( $host !~ ^(app.example.com)$ ) {
         return 444;
    }
    # Metodos http permitidos
    if ($request_method !~ ^(GET|HEAD|POST)$ ) {
         return 444;
    }
    # Directorio para STATIC
    location /static/ {
            alias /home/www/projectwebapp/projectwebapp/static/;
    }
    # Directorio para MEDIA
    location /media/ {
            alias /home/www/projectwebapp/projectwebapp/media/;
    }

    location / {

        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # Configuracion HTTPS
        #proxy_set_header X-Forwarded-Proto https;

        proxy_set_header Host $http_host;
        proxy_redirect off;

        if (!-f $request_filename) {
            proxy_pass http://projectwebapp;
            break;
        }
    }

   # Paginas de error 
    error_page 500 502 503 504 /500.html;
    location = /500.html {
        root /home/www/projectwebapp/templates/;
    }
    error_page 404 /404.html;
    location = /404.html {
        root /home/www/projectwebapp/templates/;
    }

    }
</code></pre>
</div>

<p>Habilitamos nuestro archivo de sitio</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ ln -s /etc/nginx/sites-available/projectwebapp.conf /etc/nginx/sites-enabled/projectwebapp.conf
</code></pre>
</div>

<p>Reiniciamos nginx</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ service nginx restart
</code></pre>
</div>

<p>IPTABLES. Firewall</p>

<p>No olvidar abrir los respectivos puertos que usara nginx para darle salida a nuestros sitios.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/sysconfig/iptables
-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT
$ service iptables restart
</code></pre>
</div>

</div>

<div class="related">
  <h2>Quizas te interese</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2017/02/20/aplicaci%C3%B3n-de-parches-en-vmware-esxi-5x/">
            Aplicación de parches en VMware ESXi 5.x
            <small>20 Feb 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/12/09/clonaci%C3%B3n-y-migraci%C3%B3n-en-tiempo-real-live/">
            Clonación y migración en tiempo real de instancias virtuales Qemu/KVM
            <small>09 Dec 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/12/04/the-netflix-tech-blog-an%C3%A1lisis-del-rendimiento/">
            Análisis del rendimiento de Linux en 60 Segundos
            <small>04 Dec 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
