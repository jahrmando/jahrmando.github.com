<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Configuración un Stack Django en CentOS 6.x</title>
  <meta name="description" content="Stack: NGINX, GUNICORN, VIRTUALENV y SUPERVISOR PRE INSTALACIONInstalamos los siguientes paquetes para compilaciones. Es de utilidad en algunos paquetes que ...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="jahrmando.github.com/2013/10/16/configuracion-de-django-en-centos-6x.html">
  <link rel="alternate" type="application/rss+xml" title="Tech Monkey" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Tech Monkey</a>
  
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
            <a class="page-link" href="/about/">About</a>
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Configuración un Stack Django en CentOS 6.x</h1>
    <p class="post-meta">
      <time datetime="2013-10-16T11:06:00-05:00" itemprop="datePublished">
        
        Oct 16, 2013
      </time>
      </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Stack: NGINX, GUNICORN, VIRTUALENV y SUPERVISOR</p>
<b>PRE INSTALACION</b><br />Instalamos los siguientes paquetes para compilaciones. Es de utilidad en algunos paquetes que instalemos dentro de PIP y los archivos de desarrollo de python.<br /><pre class="brush:bash">$ yum install gcc make python-devel<br /></pre><b>PIP, VIRTUALENV</b><br />Instalamos PIP desde los repositorios EPEL<br /><pre class="brush:bash">$ yum -y install python-pip --enablerepo epel<br /></pre>Instalamos virtualenvwrapper desde PIP, este instalara como dependencia a virtualenv.<br /><pre class="brush:bash">$ pip install virtualenvwrapper<br /></pre>Creamos nuestras variables de sistema para virtualenv y lo alojamos en el archivo de configuración bash del usuario unix.<br /><pre class="brush:bash">$ echo 'export WORKON_HOME=/opt/virtualenvs' &gt;&gt; $HOME/.bashrc<br />$ echo 'export VIRTUALENVWRAPPER_HOOK_DIR=$WORKON_HOME/hooks' &gt;&gt; $HOME/.bashrc<br />$ echo 'source /usr/bin/virtualenvwrapper.sh' &gt;&gt; $HOME/.bashrc<br /></pre>Creamos la carpeta para HOOKs.<br /><pre class="brush:bash">$ mkdir /opt/virtualenvs/hooks<br /></pre>Creamos un entorno virtual de prueba<br /><pre class="brush:bash">$ mkvirtualenv projectwebapp<br /></pre>Salimos del entorno virtual<br /><pre class="brush:bash">(projectwebapp)$ deactivate<br /></pre><b>DJANGO</b><br /><a name='more'></a><br />Creamos una carpeta donde alojaremos nuestros proyectos Django y nos cambiamos al directorio.<br /><pre class="brush:bash">$ mkdir /home/www/<br />$ cd /home/www<br /></pre>Habilitamos el entorno virtual para el proyecto<br /><pre class="brush:bash">www $ workon projectwebapp<br /></pre>Instalamos Django desde PIP y creamos un proyecto Django<br /><pre class="brush:bash">(projectwebapp) www $ pip install django<br />(projectwebapp) www $ django-admin.py startproject projectwebapp<br />(projectwebapp) www $ cd projectwebapp/<br /></pre>Iniciamos el servicio http de Django nativo para probar que todo este funcional hasta este punto.<br /><pre class="brush:bash">(projectwebapp) projectwebapp $ python manage.py runserver<br />Validating models...<br />0 errors found<br />October 15, 2013 - 13:54:33<br />Django version 1.5.4, using settings 'projectwebapp.settings'<br />Development server is running at http://127.0.0.1:8000/<br />Quit the server with CONTROL-C.<br /></pre>Detenemos el servicio Django con el atajo de teclado CONTROL-C.<br /><b><br /></b> <b>GUNICORN. Python WSGI HTTP Server&nbsp;</b><br />Instalamos gunicorn via PIP dentro del entorno virtual del proyecto. También se instala setproctitle que nos permite renombrar el proceso gunicorn por el nombre del proyecto Django.<br /><pre class="brush:bash">(projectwebapp) projectwebapp $ pip install gunicorn setproctitle<br /></pre>Estando en la carpeta del proyecto iniciamos el proyecto con gunicorn usando el modulo WSGI del proyecto Django.<br /><pre class="brush:bash">(projectwebapp) projectwebapp $ gunicorn projectwebapp.wsgi<br />2013-10-15 15:05:17 [13252] [INFO] Starting gunicorn 18.0<br />2013-10-15 15:05:17 [13252] [INFO] Listening at: http://127.0.0.1:8000 (13252)<br />2013-10-15 15:05:17 [13252] [INFO] Using worker: sync<br />2013-10-15 15:05:17 [13257] [INFO] Booting worker with pid: 13257<br /></pre>Detenemos el servicio Gunicorn con el atajo de teclado CONTROL-C.<br /><pre class="brush:bash">^C2013-10-15 15:05:33 [13257] [INFO] Worker exiting (pid: 13257)<br />2013-10-15 15:05:33 [13252] [INFO] Handling signal: int<br />2013-10-15 15:05:33 [13252] [INFO] Shutting down: Master<br /></pre>Salimos del entorno virtual<br /><pre class="brush:bash">(projectwebapp) projectwebapp $ deactive<br /></pre>Creamos el directorio donde alojaremos el script bash que nos iniciara el Gunicorn, debemos tener creado antes el directorio /opt/gunicorn/ para alojar mas proyectos.<br /><pre class="brush:bash">$ mkdir /opt/gunicorn/projectwebapp/<br /></pre>Creamos y editamos el archivo script para ejecutar el proyecto con gunicorn<br /><pre class="brush:bash">$ vim /opt/gunicorn/projectwebapp/gunicorn_start.sh<br />#!/bin/bash<br /><br />DJANGODIR=/home/www/projectwebapp             # Directorio del proyecto Django<br />SOCKFILE=/var/run/gunicorn/projectwebapp.sock # Unix socket<br />USER=nginx                                    # Usuario <br />GROUP=root                                    # Grupo<br />NUM_WORKERS=3                                 # Numero de procesos para gunicorn<br />DJANGO_SETTINGS_MODULE=projectwebapp.settings # Archivo settings del proyecto<br />DJANGO_WSGI_MODULE=projectwebapp.wsgi         # Modulo WSGI del proyecto<br /><br /># Activar el entorno virtual<br />cd $DJANGODIR<br />source /usr/bin/virtualenvwrapper.sh<br />workon projectwebapp<br />export DJANGO_SETTINGS_MODULE=$DJANGO_SETTINGS_MODULE<br />export PYTHONPATH=$DJANGODIR:$PYTHONPATH<br /><br /># Crear el directorio del socket si no existe<br />RUNDIR=$(dirname $SOCKFILE)<br />test -d $RUNDIR || mkdir -p $RUNDIR<br /><br /># Iniciar el proyecto Django<br /># No se usa el modo --daemon ya que este sera manejado por supervisor<br />exec gunicorn ${DJANGO_WSGI_MODULE} \<br />  --workers $NUM_WORKERS \<br />  --user=$USER --group=$GROUP \<br />  --log-level=debug \<br />  --bind=unix:$SOCKFILE<br /></pre>Permisos de ejecución<br /><pre class="brush:bash">$ chmod u+x /opt/gunicorn/projectwebapp/gunicorn_start.sh<br /></pre>Ejecutamos el script para probar el funcionamiento correcto<br /><pre class="brush:bash">$ /opt/gunicorn/projectwebapp/gunicorn_start.sh<br /></pre><b>SUPERVISOR. Cliente/Servidor de monitoreo y control de procesos&nbsp;</b><br />Instalamos la mas reciente versión de supervisor desde PIP.<br /><pre class="brush:bash">$ pip install supervisor<br /></pre>Creamos el archivo de configuración.<br /><pre class="brush:bash">$ echo_supervisord_conf &gt; /etc/supervisord.conf<br /></pre>Creamos la carpeta de logs.<br /><pre class="brush:bash">$ mkdir /var/log/supervisor<br /></pre>Configuramos los siguientes parámetros.<br /><pre class="brush:bash">$ vim /etc/supervisord.conf<br /># Modifique las siguientes configuraciones<br />[unix_http_server] <br />...<br />file=/var/run/supervisor.sock<br />...<br />[supervisord]<br />...<br />logfile=/var/log/supervisor/supervisord.log<br />pidfile=/var/run/supervisord.pid <br />umask=022<br />user=root<br />...<br /></pre>Creamos el script para supervisor que ejecutara el servicio como daemon y auto inicio con el sistema. Este es una adaptación propia basado en el script de Mike McGrath <mmcgrath redhat.com=""> </mmcgrath><br /><pre class="brush:bash">$ vim /etc/init.d/supervisord<br />#!/bin/bash<br />#<br /># supervisord   This scripts turns supervisord on<br />#<br /># chkconfig: - 95 04<br />#<br /># processname:  supervisord<br /># config: /etc/supervisord.conf<br />#<br /><br /># source function library<br />. /etc/rc.d/init.d/functions<br /><br />RETVAL=0<br />conffile=${CONFFILE-/etc/supervisord.conf}<br />user=${USER-root}<br /><br />start() {<br />        echo -n $"Starting supervisord: "<br />        runuser -l ${user} -c "supervisord -c ${conffile}" && echo_success || echo_failure<br />        RETVAL=$?<br />        echo<br />        [ $RETVAL -eq 0 ] &amp;&amp; touch /var/lock/subsys/supervisord<br />}<br /><br />stop() {<br /> echo -n $"Stopping supervisord: "<br /> killproc supervisord<br /> echo<br /> [ $RETVAL -eq 0 ] &amp;&amp; rm -f /var/lock/subsys/supervisord<br />}<br /><br />restart() {<br /> stop<br /> start<br />}<br /><br />case "$1" in<br />  start)<br /> start<br /> ;;<br />  stop) <br /> stop<br /> ;;<br />  restart|force-reload|reload)<br /> restart<br /> ;;<br />  condrestart)<br /> [ -f /var/lock/subsys/supervisord ] &amp;&amp; restart<br /> ;;<br />  status)<br /> status supervisord<br /> RETVAL=$?<br /> ;;<br />  *)<br /> echo $"Usage: $0 {start|stop|status|restart|reload|force-reload|condrestart}"<br /> exit 1<br />esac<br /><br />exit $RETVAL<br /></pre>Damos de alta nuestro script como servicio.<br /><pre class="brush:bash">$ chkconfig --add supervisord<br /></pre>Lo agregamos al inicio de sistema con el runrevel por defecto.<br /><pre class="brush:bash">$ chkconfig supervisord on<br /></pre>Iniciamos el servicio.<br /><pre class="brush:bash">$ service supervisord start<br /></pre>Configuramos una instancia de programa agregando nuestro script gunicorn que ejecuta nuestra app Django.<br /><pre class="brush:bash">$ vim /etc/supervisord.conf<br /># Agregue este bloque de configuracion segun su proyecto<br />[program:projectwebapp]<br />command=/opt/gunicorn/projectwebapp/gunicorn_start.sh<br />user=root<br />autostart=true<br />autorestart=true<br />stdout_logfile=/var/log/supervisor/projectwebapp.log<br />redirect_stderr=True<br /></pre>Reiniciamos supervisor<br /><pre class="brush:bash">$ service supervisord restart<br /></pre><b>  NGINX. HTTP Server</b><br /><div>Instalamos la repo NGINX oficial.  <br /><pre class="brush:bash">$ touch /etc/yum.repos.d/nginx.repo<br />$ vim /etc/yum.repos.d/nginx.repo<br />[nginx]<br />name=nginx repo<br />baseurl=http://nginx.org/packages/centos/6/$basearch/<br />gpgcheck=0<br />enabled=1<br /></pre>Instalamos nginx, los agregamos al inicio de sistema e iniciamos.  <br /><pre class="brush:bash">$ yum install nginx<br />$ chkconfig nginx on<br />$ service nginx start<br /></pre>Creamos las carpetas donde alojamos configuración de los sitios. <br /><pre class="brush:bash">$ mkdir /etc/nginx/sites-available<br />$ mkdir /etc/nginx/sites-enabled<br />$ mkdir /var/log/nginx/sites<br /></pre>Mas información sobre estas configuración de nginx y buenas practicas en  http://desdelocalhost.blogspot.mx/2013/03/instalacion-y-configuracion-de-nginx.html.  Creamos un respaldo de la configuración global y aplicamos las configuraciones siguientes para el servicio.  <br /><pre class="brush:bash">$ cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.old<br />$ vim /etc/nginx/nginx.conf<br />user  nginx;<br /># Numero de CPUs<br />worker_processes  2;<br /> <br />error_log  /var/log/nginx/error.log warn;<br />pid        /var/run/nginx.pid;<br /> <br /> <br />events {<br />    worker_connections  1024;<br />}<br /> <br />http {<br />    include       /etc/nginx/mime.types;<br />    default_type  application/octet-stream;<br /> <br />    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '<br />                      '$status $body_bytes_sent "$http_referer" '<br />                      '"$http_user_agent" "$http_x_forwarded_for"';<br /> <br />    access_log  /var/log/nginx/access.log  main;<br /> <br />    sendfile        on;<br />    ## Optimiza el rendimiento de sendfile al enviar tramas HTTP<br />    ## en un solo paquete.<br />    tcp_nopush     on;<br />    ## Soporte gzip. Reduce la cantidad de datos a transferir<br />    gzip  on;<br /> <br />    ## Configuracion de buffers<br />    client_body_buffer_size  1K;<br />    client_header_buffer_size 1k;<br />    client_max_body_size 1k;<br />    large_client_header_buffers 2 1k;<br /> <br />    ## Configuracion de timeouts <br />    client_body_timeout   10;<br />    client_header_timeout 10;<br />    keepalive_timeout     5 5;<br />    send_timeout          10;<br /> <br />    include /etc/nginx/conf.d/*.conf;<br />     <br />    ## Directorio de configuracion para vhost's en linea<br />    include /etc/nginx/sites-enabled/*.conf;<br />}<br /></pre>Agregamos la ip 127.0.0.1 para escucha solo local del sitio default, también podemos borrar este archivo si quieren des-habilitar completamente.  <br /><pre class="brush:bash">$ vim /etc/nginx/conf.d/default.conf <br />server {<br />    listen       127.0.0.1:80;<br /></pre>Creamos y configuramos el sitio para nuestro proyecto projectwebapp de la siguiente manera. <br /><pre class="brush:bash">$ vim /etc/nginx/sites-available/projectwebapp.conf<br /># Configuracion NGINX para projectwebapp<br />#<br />upstream projectwebapp {<br />  server unix:/var/run/gunicorn/projectwebapp.sock fail_timeout=0;<br />}<br /><br />server {<br />    listen       10.0.0.23:80;<br /><br />    # Configuracion HTTPS<br />    # listen       10.0.0.23:443 ssl;<br /><br />    server_name  app.example.com;<br />    server_tokens off;<br /><br />    access_log  /var/log/nginx/sites/projectwebapp.access.log;<br />    error_log  /var/log/nginx/sites/projectwebapp.error.log;<br /><br />    # Configuracion HTTPS<br />    #ssl_certificate     /etc/nginx/ssl/server.crt;<br />    #ssl_certificate_key /etc/nginx/ssl/server.key;<br />    #ssl_prefer_server_ciphers on;<br />    #ssl_protocols       SSLv3 TLSv1 TLSv1.1 TLSv1.2;<br />    #ssl_session_cache shared:SSL:2m;<br />    #ssl_ciphers RC4:HIGH:!MD5:!aNULL:!DH:!EDH;<br /><br />    # HTTP Strict Transport Security (HSTS). Configuracion HTTPS<br />    #add_header Strict-Transport-Security max-age=31536000;<br /><br />    # Limite subidas de archivos.<br />    client_max_body_size 1M;<br /><br />    # Acceso solo por medio del dominio<br />    if ( $host !~ ^(app.example.com)$ ) {<br />         return 444;<br />    }<br />    # Metodos http permitidos<br />    if ($request_method !~ ^(GET|HEAD|POST)$ ) {<br />         return 444;<br />    }<br />    # Directorio para STATIC<br />    location /static/ {<br />            alias /home/www/projectwebapp/projectwebapp/static/;<br />    }<br />    # Directorio para MEDIA<br />    location /media/ {<br />            alias /home/www/projectwebapp/projectwebapp/media/;<br />    }<br /><br />    location / {<br /><br />        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;<br /><br />        # Configuracion HTTPS<br />        #proxy_set_header X-Forwarded-Proto https;<br /><br />        proxy_set_header Host $http_host;<br />        proxy_redirect off;<br /><br />        if (!-f $request_filename) {<br />            proxy_pass http://projectwebapp;<br />            break;<br />        }<br />    }<br /><br />   # Paginas de error <br />    error_page 500 502 503 504 /500.html;<br />    location = /500.html {<br />        root /home/www/projectwebapp/templates/;<br />    }<br />    error_page 404 /404.html;<br />    location = /404.html {<br />        root /home/www/projectwebapp/templates/;<br />    }<br /><br />}<br /></pre>Habilitamos nuestro archivo de sitio <br /><pre class="brush:bash">$ ln -s /etc/nginx/sites-available/projectwebapp.conf /etc/nginx/sites-enabled/projectwebapp.conf<br /></pre>Reiniciamos nginx <br /><pre class="brush:bash">$ service nginx restart<br /></pre><b>  IPTABLES. Firewall</b><br />No olvidar abrir los respectivos puertos que usara nginx para darle salida a nuestros sitios.&nbsp;</div><div><pre class="brush:bash">$ vim /etc/sysconfig/iptables<br />-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT<br />$ service iptables restart<br /></pre></div>
  </div>

  
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Tech Monkey</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              Tech Monkey
            
            </li>
            
            <li><a href="mailto:me@jahrmando.com">me@jahrmando.com</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/jahrmando"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">jahrmando</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/jahrmando"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">jahrmando</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>An Accidental Engineer • Tech Monkey • #Linux #DevOps #Programmer #Infosec
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
