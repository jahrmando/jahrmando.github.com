<!DOCTYPE html>
<html lang="es">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Configuración de NGINX-CentOS-PHP &middot; Tech Monkey
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/blackdoc.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=EB+Garamond">
  <link href="https://fonts.googleapis.com/css?family=Bree+Serif|Coustard" rel="stylesheet">
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Tech Monkey
        </a>
      </h1>
      <p class="lead">An Accidental Engineer • #Linux #DevOps #Programmer #Infosec</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">Acerca de</a>
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

      <hr>
      <a class="sidebar-nav-item" href="https://github.com/jahrmando/blackdoc">Repositorios</a>
    </nav>

    <p>&copy; 2017. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Configuración de NGINX-CentOS-PHP</h1>
  <span class="post-date">27 Mar 2013</span>
  <p>Este post le instalara Nginx y PHP-FPM en Centos</p>

<p>Instalación NGINX</p>

<p>Descargamos el repositorio del sitio oficial NGINX, lo instalamos e inhabilitamos su carga automática.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ wget http://nginx.org/packages/centos/6/noarch/RPMS/nginx-release-centos-6-0.el6.ngx.noarch.rpm
$ yum localinstall nginx-release-centos-6-0.el6.ngx.noarch.rpm 
$ vim /etc/yum.repos.d/nginx.repo 
# nginx.repo
[nginx]
name=nginx repo
baseurl=http://nginx.org/packages/centos/6/$basearch/
gpgcheck=0
# 1:Activo 0: Desactivado
enabled=0
</code></pre>
</div>

<p>Instalamos el paquete NGINX usando el repositorio previamente instalado, despues activamos el inicio automatico del servicio con el sistema.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ yum install nginx --enablerepo nginx
$ chkconfig nginx on
$ service nginx start
</code></pre>
</div>

<p>Como buena practica de configuración, creamos la carpeta “sites-available” donde alojaremos los archivos de configuración de nuestros sitios (virtualhost) y la carpeta “sites-enabled” que nos servirá para crear enlaces simbólicos hacia los archivos de configuración “sites-available” esto ponerlos en un estado “online”.  De igual forma creamos el directorio “sites” dentro de la carpeta de logs de NGINX como buena practica para tener ordenado nuestros registros de cada sitio que levantemos.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ mkdir /etc/nginx/sites-available
$ mkdir /etc/nginx/sites-enabled
$ mkdir /var/log/nginx/sites
</code></pre>
</div>

<p>Creamos un respaldo de la configuración global y aplicamos las configuraciones siguientes para el servicio.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.old
$ vim /etc/nginx/nginx.conf
user  nginx;
## Numero de CPUs
worker_processes  2;
error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;
events {
    worker_connections  1024;
    }
http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';
    access_log  /var/log/nginx/access.log  main;
    sendfile        on;
    ## Optimiza el rendimiento de sendfile al enviar tramas HTTP
    ## en un solo paquete.
    tcp_nopush     on;
    ## Soporte gzip. Reduce la cantidad de datos a transferir
    gzip  on;
    ## Configuracion de buffers
    client_body_buffer_size  1K;
    client_header_buffer_size 1k;
    client_max_body_size 1k;
    large_client_header_buffers 2 1k;
    ## Configuracion de timeouts 
    client_body_timeout   10;
    client_header_timeout 10;
    keepalive_timeout     5 5;
    send_timeout          10;
    include /etc/nginx/conf.d/*.conf;

    ## Directorio de configuracion para vhost's en linea
    include /etc/nginx/sites-enabled/*.conf;
    }
</code></pre>
</div>

<p>Agregamos la ip <code class="highlighter-rouge">127.0.0.1</code> para escucha solo local del sitio default, también podemos borrar este archivo si quieren deshabilitar completamente.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/nginx/conf.d/default.conf 
server {
    listen       127.0.0.1:80;
    
    Abrimos el puerto 80 en el firewall y reiniamos el servicio 

$ vim /etc/sysconfig/iptables
-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT
$ service iptables restart
</code></pre>
</div>

<p>Soporte PHP</p>

<p>Instalamos los paquetes para el soporte a PHP con PHP-FPM, habilitamos PHP-FPM como servicio, lo cargamos para que inicie con el sistema operativo.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ yum install php-fpm php-common php-pecl-apc php-cli php-pear php-pdo \
php-mysql php-gd php-mbstring php-xml
$ chkconfig --add php-fpm
$ chkconfig php-fpm on
</code></pre>
</div>

<p>Cambiamos el propietario por nginx, limitamos el tiempo de ejecución de una petición php y aseguramos que solo se usen extensiones php validas.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/php-fpm.d/www.conf 
;listen = 127.0.0.1:9000
listen = /var/run/php5-fpm.sock
;listen.allowed_clients = 127.0.0.1
;user = apache
;group = apache
user = nginx
group = nginx
request_terminate_timeout = 30s
security.limit_extensions = .php .php3 .php4 .php5 
php_value[session.save_handler] = files
php_value[session.save_path] = /var/lib/php/session
</code></pre>
</div>

<p>Asegúrese de que exista este directorio <code class="highlighter-rouge">/var/lib/php/session/</code> ya que es donde se guardara las sesiones php y el directorio <code class="highlighter-rouge">/var/lib/php/tmp/</code> donde se alojaremos archivos temporales que se suban.</p>

<p>$ mkdir /var/lib/php
$ mkdir /var/lib/php/session
$ mkdir /var/lib/php/tmp/
$ chown nginx:nginx -R /var/lib/php/
$ chmod 750 -r /var/lib/php/session/</p>

<p>Creamos un archivo de llamado security.ini para PHP donde pondremos algunas configuraciones que reforzaran la seguridad de su sitio, ponga a consideración personal aplicarlas o modificar las variables de acuerdo a su servidor.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$  vim /etc/php.d/security.ini 
; Ocultar version de PHP
expose_php=Off
; Ocultar errores
display_errors=Off
; Bloquear subidas de archivos
;file_uploads=Off
; ó limitar los archivos a subir
file_uploads=On
upload_max_filesize=1M
; Bloquear ejecucion remota via ftp,http
allow_url_fopen=Off
allow_url_include=Off
; Desactivar (Obsoleto a partir de PHP 5.4.0)
magic_quotes_gpc=Off
; Limita los paquetes POST, (Default 8M)
post_max_size=1M
; Control de recursos
max_execution_time =  30
max_input_time = 30
memory_limit = 8M
; Desactivar funciones que podrían ser explotadas
disable_functions = exec,passthru,shell_exec,system,proc_open,popen,curl_multi_exec,parse_ini_file,show_source,phpinfo
; Directorio temporal
upload_tmp_dir = /var/lib/php/tmp/
; Limitar la ejecución a php en directorio
open_basedir = /home/www/ 
</code></pre>
</div>

<p>Iniciamos el servicio</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ service php-fpm start
Iniciando php-fpm:                                         [  OK  ]
</code></pre>
</div>

<p>Configuramos el vhost</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/nginx/sites-available/ejemplo.com.mx.conf 
server {
    listen       [IP]:80;
    server_name  www.ejemplo.com.mx ejemplo.com.mx;
    ## Deshabilitamos que imprima la version de NGINX ##
    server_tokens off;
    ## Registros del virtualhost ##
    access_log  /var/log/nginx/sites/ejemplo.access.log;
    error_log  /var/log/nginx/sites/ejemplo.error.log;
    ## Acceso solo por hostname valido ##
    if ( $host !~ ^(ejemplo.com.mx|www.ejemplo.com.mx)$ ) {
         return 444;
    }
    ## Metodos validos ##
    if ($request_method !~ ^(GET|HEAD|POST)$ ) {
         return 444;
    }
    location / {
     ## Los index validos, entre ellos el .php
        index  index.html index.htm index.php;
        ## Directorio absoluto
        root  /home/www/ejemplo.com.mx/public_html;
        ## Soporte PHP ##
        location ~ \.php$ {
                root            public_html;
                fastcgi_pass    unix:/var/run/php5-fpm.sock;
                fastcgi_index   index.php;
                fastcgi_param   SCRIPT_FILENAME  /home/www/ejemplo.com.mx/public_html$fastcgi_script_name;
                include         /etc/nginx/fastcgi_params;
        }
        ## Denegar accesos a archivos ocultos ##
        location ~ /\. { deny  all; }
        ## Bloquear logs de archivos estaticos ###
        location ~* \.(jpg|jpeg|gif|png|css|js|ico|xml)$ {
                access_log        off;
                log_not_found     off;
                expires           360d;
        }
    }
    }
</code></pre>
</div>

<p>Habilitamos la configuración de nuestro sitio y reiniciamos el servicio</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ cd /etc/nginx/sites-enabled/
$ ln -s /etc/nginx/sites-available/ejemplo.com.mx.conf
$ service nginx restart
</code></pre>
</div>

<p>Soporte SSL</p>

<p>Para soporte SSL agregamos la siguiente configuracion</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/nginx/sites-available/ejemplo.com.mx.conf 
server {
    ## Escucha en puerto 443
    listen      [IP]:443 ssl;
    ## Soporte SSL ##
    ssl_certificate     /etc/nginx/ssl/server.crt;
    ssl_certificate_key /etc/nginx/ssl/server.key;
    ssl_prefer_server_ciphers on;
    ssl_protocols       SSLv3 TLSv1 TLSv1.1 TLSv1.2;
    ssl_session_cache shared:SSL:2m;
    ssl_ciphers RC4:HIGH:!MD5:!aNULL:!DH:!EDH;
</code></pre>
</div>

<p>Creamos el directorio para nuestro certificado (5 años de vigencia, modifique la cantidad de días a su gusto) y la creamos dentro de la carpeta</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ mkdir /etc/nginx/ssl/
$ cd /etc/nginx/ssl/
[user@host ssl]# openssl genrsa -des3 -out server.key 2048
[user@host ssl]# openssl req -new -key server.key -out server.csr
[user@host ssl]# cp server.key server.key.com
[user@host ssl]# openssl rsa -in server.key.com -out server.key
[user@host ssl]# openssl x509 -req -days 1825 -in server.csr -signkey server.key -out server.crt
</code></pre>
</div>

<p>Abrimos el puerto 443 en el firewall y reiniciamos el servicio</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/sysconfig/iptables
-A INPUT -m state --state NEW -m tcp -p tcp --dport 443 -j ACCEPT
$ service iptables restart
</code></pre>
</div>

<p>Reiniciamos el servicio</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ service nginx restart
</code></pre>
</div>

<p>Configuración de logrotate</p>

<p>Agregamos el directorio donde estamos poniendo nuestros logs de sitios en el archivo de configuración de logrotate de nginx.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/logrotate.d/nginx 
/var/log/nginx/*.log /var/log/nginx/*/*.log {
        weekly
        missingok
        rotate 4
        compress
        delaycompress
        notifempty
        create 640 nginx nginx
        sharedscripts
        postrotate
                [ -f /var/run/nginx.pid ] &amp;amp;&amp;amp; kill -USR1 `cat /var/run/nginx.pid`
        endscript
        }
</code></pre>
</div>

<p>Soporte PROXY estilo apache</p>

<p>Incluimos en un archivo de configuración separada los parámetros para proxy</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ touch /etc/nginx/proxy.conf 
$ vim /etc/nginx/proxy.conf 
proxy_redirect          off;
proxy_set_header        Host            $host;
proxy_set_header        X-Real-IP       $remote_addr;
proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
client_max_body_size    10m;
client_body_buffer_size 128k;
proxy_connect_timeout   90;
proxy_send_timeout      90;
proxy_read_timeout      90;
proxy_buffers           32 4k;
</code></pre>
</div>

<p>Configuración extra para los vhost que requieran el proxy</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/nginx/sites-available/ejemplo.com.mx.conf 
upstream srv1 {
  server [IP o Domain name]:80;
  }
server {
    #...
    #...

    location /alproxy/ {
        proxy_pass http://srv1/;
        include /etc/nginx/proxy.conf;
    }

    #...
    #...
    }
</code></pre>
</div>

</div>

<div class="related">
  <h2>Quizas te interese</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2015/12/04/the-netflix-tech-blog-an%C3%A1lisis-del-rendimiento/">
            Análisis del rendimiento de Linux en 60 Segundos
            <small>04 Dec 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/03/27/sitio-en-mantenimiento-con-nginx/">
            Manejar un estado de Mantemiento WebSite con NGINX
            <small>27 Mar 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/03/13/excelente-cheat-sheet-para-principiantes-de-vim/">
            Excelente cheat sheet de VIM
            <small>13 Mar 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
