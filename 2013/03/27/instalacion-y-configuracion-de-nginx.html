<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Instalación y configuración de NGINX en CentOS (PHP)</title>
  <meta name="description" content="Instalación NGINX&amp;nbsp;Descargamos el repositorio del sitio oficial NGINX, lo instalamos e inhabilitamos su carga automática.[user@host ~]# wget http://nginx...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="jahrmando.github.com/2013/03/27/instalacion-y-configuracion-de-nginx.html">
  <link rel="alternate" type="application/rss+xml" title="Tech Monkey" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Tech Monkey</a>
  
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
            <a class="page-link" href="/about/">About</a>
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Instalación y configuración de NGINX en CentOS (PHP)</h1>
    <p class="post-meta">
      <time datetime="2013-03-27T12:13:00-06:00" itemprop="datePublished">
        
        Mar 27, 2013
      </time>
      </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <br /><b>Instalación NGINX&nbsp;</b><br /><br />Descargamos el repositorio del sitio oficial NGINX, lo instalamos e inhabilitamos su carga automática.<br /><pre class="brush:bash">[user@host ~]# wget http://nginx.org/packages/centos/6/noarch/RPMS/nginx-release-centos-6-0.el6.ngx.noarch.rpm<br />[user@host ~]# yum localinstall nginx-release-centos-6-0.el6.ngx.noarch.rpm <br />[user@host ~]# vim /etc/yum.repos.d/nginx.repo <br /># nginx.repo<br />[nginx]<br />name=nginx repo<br />baseurl=http://nginx.org/packages/centos/6/$basearch/<br />gpgcheck=0<br /># 1:Activo 0: Desactivado<br />enabled=0<br /></pre><br />Instalamos el paquete NGINX usando el repositorio previamente instalado, despues activamos el inicio automatico del servicio con el sistema. <br /><pre class="brush:bash">[user@host ~]# yum install nginx --enablerepo nginx<br />[user@host ~]# chkconfig nginx on<br />[user@host ~]# service nginx start<br /></pre><br />Como buena practica de configuración, creamos la carpeta "sites-available" donde alojaremos los archivos de configuración de nuestros sitios (virtualhost) y la carpeta "sites-enabled" que nos servirá para crear enlaces simbólicos hacia los archivos de configuración "sites-available" esto ponerlos en un estado "online".  De igual forma creamos el directorio "sites" dentro de la carpeta de logs de NGINX como buena practica para tener ordenado nuestros registros de cada sitio que levantemos. <br /><pre class="brush:bash">[user@host ~]# mkdir /etc/nginx/sites-available<br />[user@host ~]# mkdir /etc/nginx/sites-enabled<br />[user@host ~]# mkdir /var/log/nginx/sites<br /></pre><a name='more'></a><br />Creamos un respaldo de la configuración global y aplicamos las configuraciones siguientes para el servicio. <br /><pre class="brush:bash">[user@host ~]# cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.old<br />[user@host ~]# vim /etc/nginx/nginx.conf<br />user  nginx;<br />## Numero de CPUs<br />worker_processes  2;<br /><br />error_log  /var/log/nginx/error.log warn;<br />pid        /var/run/nginx.pid;<br /><br /><br />events {<br />    worker_connections  1024;<br />}<br /><br />http {<br />    include       /etc/nginx/mime.types;<br />    default_type  application/octet-stream;<br /><br />    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '<br />                      '$status $body_bytes_sent "$http_referer" '<br />                      '"$http_user_agent" "$http_x_forwarded_for"';<br /><br />    access_log  /var/log/nginx/access.log  main;<br /><br />    sendfile        on;<br />    ## Optimiza el rendimiento de sendfile al enviar tramas HTTP<br />    ## en un solo paquete.<br />    tcp_nopush     on;<br />    ## Soporte gzip. Reduce la cantidad de datos a transferir<br />    gzip  on;<br /><br />    ## Configuracion de buffers<br />    client_body_buffer_size  1K;<br />    client_header_buffer_size 1k;<br />    client_max_body_size 1k;<br />    large_client_header_buffers 2 1k;<br /><br />    ## Configuracion de timeouts <br />    client_body_timeout   10;<br />    client_header_timeout 10;<br />    keepalive_timeout     5 5;<br />    send_timeout          10;<br /><br />    include /etc/nginx/conf.d/*.conf;<br />    <br />    ## Directorio de configuracion para vhost's en linea<br />    include /etc/nginx/sites-enabled/*.conf;<br />}<br /></pre><br />Agregamos la ip 127.0.0.1 para escucha solo local del sitio default, también podemos borrar este archivo si quieren deshabilitar completamente.  <br /><pre class="brush:bash">[user@host ~]# vim /etc/nginx/conf.d/default.conf <br />server {<br />    listen       127.0.0.1:80;<br /></pre>Abrimos el puerto 80 en el firewall y reiniamos el servicio <br /><pre class="brush:bash">[user@host ~]# vim /etc/sysconfig/iptables<br />-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT<br />[user@host ~]# service iptables restart<br /></pre><br /><b>Soporte PHP</b><br /><br />Instalamos los paquetes para el soporte a PHP con PHP-FPM, habilitamos PHP-FPM como servicio, lo cargamos para que inicie con el sistema operativo.<br /><pre class="brush:bash">[user@host ~]# yum install php-fpm php-common php-pecl-apc php-cli php-pear php-pdo \<br />php-mysql php-gd php-mbstring php-xml<br />[user@host ~]# chkconfig --add php-fpm<br />[user@host ~]# chkconfig php-fpm on<br /></pre>Cambiamos el propietario por nginx, limitamos el tiempo de ejecución de una petición php y aseguramos que solo se usen extensiones php validas. <br /><pre class="brush:bash">[user@host ~]# vim /etc/php-fpm.d/www.conf <br />;listen = 127.0.0.1:9000<br />listen = /var/run/php5-fpm.sock<br />;listen.allowed_clients = 127.0.0.1<br />;user = apache<br />;group = apache<br />user = nginx<br />group = nginx<br />request_terminate_timeout = 30s<br />security.limit_extensions = .php .php3 .php4 .php5 <br />php_value[session.save_handler] = files<br />php_value[session.save_path] = /var/lib/php/session</pre>Asegúrese de que exista este directorio "/var/lib/php/session/" ya que es donde se guardara las sesiones php y el directorio “/var/lib/php/tmp/” donde se alojaremos archivos temporales que se suban.<br /><pre class="brush:bash">[user@host ~]# mkdir /var/lib/php<br />[user@host ~]# mkdir /var/lib/php/session<br />[user@host ~]# mkdir /var/lib/php/tmp/<br />[user@host ~]# chown nginx:nginx -R /var/lib/php/<br />[user@host ~]# chmod 750 -r /var/lib/php/session/<br /></pre>Creamos un archivo de llamado security.ini para PHP donde pondremos algunas configuraciones que reforzaran la seguridad de su sitio, ponga a consideración personal aplicarlas o modificar las variables de acuerdo a su servidor.<br /><pre class="brush:bash">[user@host ~]#  vim /etc/php.d/security.ini <br />; Ocultar version de PHP<br />expose_php=Off<br />; Ocultar errores<br />display_errors=Off<br />; Bloquear subidas de archivos<br />;file_uploads=Off<br />; ó limitar los archivos a subir<br />file_uploads=On<br />upload_max_filesize=1M<br />; Bloquear ejecucion remota via ftp,http<br />allow_url_fopen=Off<br />allow_url_include=Off<br />; Desactivar (Obsoleto a partir de PHP 5.4.0)<br />magic_quotes_gpc=Off<br />; Limita los paquetes POST, (Default 8M)<br />post_max_size=1M<br />; Control de recursos<br />max_execution_time =  30<br />max_input_time = 30<br />memory_limit = 8M<br />; Desactivar funciones que podrían ser explotadas<br />disable_functions = exec,passthru,shell_exec,system,proc_open,popen,curl_multi_exec,parse_ini_file,show_source,phpinfo<br />; Directorio temporal<br />upload_tmp_dir = /var/lib/php/tmp/<br />; Limitar la ejecución a php en directorio<br />open_basedir = /home/www/ <br /></pre>Iniciamos el servicio <br /><pre class="brush:bash">[user@host ~]# service php-fpm start<br />Iniciando php-fpm:                                         [  OK  ]<br /></pre><br /><b>Configuramos el vhost</b><br /><pre class="brush:bash">[user@host ~]# vim /etc/nginx/sites-available/ejemplo.com.mx.conf <br />server {<br />    listen       [IP]:80;<br />    server_name  www.ejemplo.com.mx ejemplo.com.mx;<br />    ## Deshabilitamos que imprima la version de NGINX ##<br />    server_tokens off;<br /><br />    ## Registros del virtualhost ##<br />    access_log  /var/log/nginx/sites/ejemplo.access.log;<br />    error_log  /var/log/nginx/sites/ejemplo.error.log;<br /><br />    ## Acceso solo por hostname valido ##<br />    if ( $host !~ ^(ejemplo.com.mx|www.ejemplo.com.mx)$ ) {<br />         return 444;<br />    }<br /><br />    ## Metodos validos ##<br />    if ($request_method !~ ^(GET|HEAD|POST)$ ) {<br />         return 444;<br />    }<br /><br />    location / {<br />     ## Los index validos, entre ellos el .php<br />        index  index.html index.htm index.php;<br /><br />        ## Directorio absoluto<br />        root  /home/www/ejemplo.com.mx/public_html;<br /><br />        ## Soporte PHP ##<br />        location ~ \.php$ {<br />                root            public_html;<br />                fastcgi_pass    unix:/var/run/php5-fpm.sock;<br />                fastcgi_index   index.php;<br />                fastcgi_param   SCRIPT_FILENAME  /home/www/ejemplo.com.mx/public_html$fastcgi_script_name;<br />                include         /etc/nginx/fastcgi_params;<br />        }<br /><br />        ## Denegar accesos a archivos ocultos ##<br />        location ~ /\. { deny  all; }<br /><br />        ## Bloquear logs de archivos estaticos ###<br />        location ~* \.(jpg|jpeg|gif|png|css|js|ico|xml)$ {<br />                access_log        off;<br />                log_not_found     off;<br />                expires           360d;<br />        }<br /><br />    }<br /><br />}</pre><br />Habilitamos la configuración de nuestro sitio y reiniciamos el servicio <br /><pre class="brush:bash">[user@host ~]# cd /etc/nginx/sites-enabled/<br />[user@host ~]# ln -s /etc/nginx/sites-available/ejemplo.com.mx.conf<br />[user@host ~]# service nginx restart<br /></pre><br /><b>Soporte SSL&nbsp;</b><br /><br />Para soporte SSL agregamos la siguiente configuracion <br /><pre class="brush:bash">[user@host ~]# vim /etc/nginx/sites-available/ejemplo.com.mx.conf <br />server {<br />    ## Escucha en puerto 443<br />    listen      [IP]:443 ssl;<br /><br />    ## Soporte SSL ##<br />    ssl_certificate     /etc/nginx/ssl/server.crt;<br />    ssl_certificate_key /etc/nginx/ssl/server.key;<br />    ssl_prefer_server_ciphers on;<br />    ssl_protocols       SSLv3 TLSv1 TLSv1.1 TLSv1.2;<br />    ssl_session_cache shared:SSL:2m;<br />    ssl_ciphers RC4:HIGH:!MD5:!aNULL:!DH:!EDH;<br /></pre><br />Creamos el directorio para nuestro certificado (5 años de vigencia, modifique la cantidad de días a su gusto) y la creamos dentro de la carpeta <br /><pre class="brush:bash">[user@host ~]# mkdir /etc/nginx/ssl/<br />[user@host ~]# cd /etc/nginx/ssl/<br />[user@host ssl]# openssl genrsa -des3 -out server.key 2048<br />[user@host ssl]# openssl req -new -key server.key -out server.csr<br />[user@host ssl]# cp server.key server.key.com<br />[user@host ssl]# openssl rsa -in server.key.com -out server.key<br />[user@host ssl]# openssl x509 -req -days 1825 -in server.csr -signkey server.key -out server.crt<br /></pre><br />Abrimos el puerto 443 en el firewall y reiniciamos el servicio <br /><pre class="brush:bash">[user@host ~]# vim /etc/sysconfig/iptables<br />-A INPUT -m state --state NEW -m tcp -p tcp --dport 443 -j ACCEPT<br />[user@host ~]# service iptables restart<br /></pre><br />Reiniciamos el servicio  <br /><pre class="brush:bash">[user@host ~]# service nginx restart<br /></pre><br /><b>Configuración de logrotate&nbsp;</b><br /><br />Agregamos el directorio donde estamos poniendo nuestros logs de sitios en el archivo de configuración de logrotate de nginx.<br /><pre class="brush:bash">[user@host ~]# vim /etc/logrotate.d/nginx <br />/var/log/nginx/*.log /var/log/nginx/*/*.log {<br />        weekly<br />        missingok<br />        rotate 4<br />        compress<br />        delaycompress<br />        notifempty<br />        create 640 nginx nginx<br />        sharedscripts<br />        postrotate<br />                [ -f /var/run/nginx.pid ] &amp;&amp; kill -USR1 `cat /var/run/nginx.pid`<br />        endscript<br />}<br /></pre><br /><b>Soporte PROXY estilo apache&nbsp;</b><br /><br />Incluimos en un archivo de configuración separada los parámetros para proxy <br /><pre class="brush:bash">[user@host ~]# touch /etc/nginx/proxy.conf <br />[user@host ~]# vim /etc/nginx/proxy.conf <br />proxy_redirect          off;<br />proxy_set_header        Host            $host;<br />proxy_set_header        X-Real-IP       $remote_addr;<br />proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;<br />client_max_body_size    10m;<br />client_body_buffer_size 128k;<br />proxy_connect_timeout   90;<br />proxy_send_timeout      90;<br />proxy_read_timeout      90;<br />proxy_buffers           32 4k;<br /></pre><br />Configuración extra para los vhost que requieran el proxy <br /><pre class="brush:bash">[user@host ~]# vim /etc/nginx/sites-available/ejemplo.com.mx.conf <br />upstream srv1 {<br />  server [IP o Domain name]:80;<br />}<br />server {<br />    #...<br />    #...<br />    <br />    location /alproxy/ {<br />        proxy_pass http://srv1/;<br />        include /etc/nginx/proxy.conf;<br />    }<br />    <br />    #...<br />    #...<br />}<br /></pre>
  </div>

  
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Tech Monkey</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              Tech Monkey
            
            </li>
            
            <li><a href="mailto:me@jahrmando.com">me@jahrmando.com</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/jahrmando"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">jahrmando</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/jahrmando"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">jahrmando</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>An Accidental Engineer • Tech Monkey • #Linux #DevOps #Programmer #Infosec
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
