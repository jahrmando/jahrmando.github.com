<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Administrando replicación en PostgreSQL con REPMGR</title>
  <meta name="description" content="Como sabemos en PostgreSQL podemos tener una configuracion de replicación maestro-esclavo (hot-standby) de forma facil, pero esta configuración no nos provee...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="jahrmando.github.com/2015/05/15/replicacion-postgresql-con-repmgr-centos.html">
  <link rel="alternate" type="application/rss+xml" title="Tech Monkey" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Tech Monkey</a>
  
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
          
            
            
            <a class="page-link" href="/about/">About</a>
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Administrando replicación en PostgreSQL con REPMGR</h1>
    <p class="post-meta">
      <time datetime="2015-05-15T18:48:11-05:00" itemprop="datePublished">
        
        May 15, 2015
      </time>
      </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Como sabemos en PostgreSQL podemos tener una configuracion de replicación maestro-esclavo (<em>hot-standby</em>) de forma facil, pero esta configuración no nos provee un <strong>failover</strong> o recuperación del maestro. Tenemos varias <a href="https://wiki.postgresql.org/wiki/Clustering" target="_blank">alternativas</a> que junto con PostgreSQL nos pueden proveer estas características.</p>

<p>Sin embargo aquí hablaremos de <a href="http://www.repmgr.org" target="_blank">REPMGR</a> que es una herramienta para poder administrar la replicación <em>hot-standby</em> de PostgreSQL, nos ofrece características como poder cambiar de modo esclavo a maestro de forma manual ó automática, capacidad de que los esclavos del cluster sigan al nuevo maestro y poder recuperar al maestro.</p>

<p>En esta publicación realizaremos los siguientes ejercicios:</p>

<ul><li>Configurar nodo maestro y dos esclavos</li>
<li>Realizar failover manual</li>
<li>Promover un nodo esclavo a maestro</li>
<li>Hacer que los nodos esclavo sigan al nuevo maestro</li>
<li>Recuperar el nodo maestro como esclavo</li>
</ul><h2>Instalación</h2>

<blockquote>
  <p>En esta publicación manejaremos <strong>PostgreSQL 9.2</strong> y <strong>CentOS 6.x</strong></p>
</blockquote>

<p>En <strong>todos</strong> nuestros nodos debemos instalar los siguientes paquetes:</p>

<ul><li>postgresql92-server</li>
<li>postgresql92-contrib</li>
<li>repmgr92</li>
<li>rsync</li>
</ul><p>Estos paquetes se encuentra dentro del <a href="http://yum.postgresql.org/repopackages.php" target="_blank">repositorio oficial de postgresql</a> (ha excepción de <em>rsync</em>) que debes instalar antes para poder encontrar los paquetes que se listan arriba.</p>

<pre><code># yum install postgresql92-server postgresql92-contrib repmgr92 rsync -y
# chkconfig postgresql-9.2 on
# service postgresql-9.2 initdb
</code></pre>

<p>Antes de empezar, tenga encuentra la siguiente estructura de configuración de red de los nodos.</p>

<table><thead><tr><th>Nombre</th>
  <th>IP</th>
  <th>Hostname</th>
</tr></thead><tbody><tr><td>nodo1</td>
  <td>192.168.1.1</td>
  <td>nodo1.example.com</td>
</tr><tr><td>nodo2</td>
  <td>192.168.1.2</td>
  <td>nodo2.example.com</td>
</tr><tr><td>nodo3</td>
  <td>192.168.1.3</td>
  <td>nodo3.example.com</td>
</tr></tbody></table><p>El nodo <strong><em>maestro</em></strong> sera el <strong><em>nodo1</em></strong> y los demás los esclavos (standby).<!-- more --></p>

<h2>Configuraciones</h2>

<h3>Configuraciones del nodo maestro</h3>

<p>Iniciamos el servicio en el nodo1</p>

<pre><code># service postgresql-9.2 start
</code></pre>

<p>Creamos un usuario y la base de datos que usara <em>REPMGR</em></p>

<pre><code>CREATE ROLE repmgr_usr LOGIN SUPERUSER;
CREATE DATABASE repmgr_db OWNER repmgr_usr;
</code></pre>

<p>Instalamos las funciones necesarias para la base de datos de <em>REPMGR</em></p>

<pre><code>$ su - postgres
$ psql -f /usr/pgsql-9.2/share/contrib/repmgr_funcs.sql repmgr_db
</code></pre>

<p>Configuración de accesos al servicio <em>postgresql</em></p>

<pre><code>$ vim /var/lib/pgsql/9.2/data/pg_hba.conf
# Acceso nodo1
host    repmgr_db       repmgr_usr  192.168.1.1/32         trust
host    replication     repmgr_usr  192.168.1.1/32         trust
# Acceso nodo2
host    repmgr_db       repmgr_usr  192.168.1.2/32         trust
host    replication     repmgr_usr  192.168.1.2/32         trust
# Acceso nodo3
host    repmgr_db       repmgr_usr  192.168.1.3/32         trust
host    replication     repmgr_usr  192.168.1.3/32         trust
</code></pre>

<blockquote>
  <p>En la publicación estaremos usando <a href="http://www.vim.org/" target="_blank">VIM</a> para editar los archivos de configuración desde terminal. Siéntase en libertad de usar la que mas le acomode (gedit, emacs, nano, etc).</p>
</blockquote>

<p>Configuraciones generales del servicio.</p>

<pre><code>$ vim /var/lib/pgsql/9.2/data/postgresql.conf
listen_addresses='*'
wal_level = 'hot_standby'
archive_mode = on
archive_command = 'cd .'
max_wal_senders = 10
wal_keep_segments = 5000
hot_standby = on
shared_preload_libraries = 'repmgr_funcs'
</code></pre>

<p>Reiniciar el servicio para cargas las nuevas configuraciones</p>

<pre><code># service postgresql-9.2 restart
</code></pre>

<h3>Configuraciones adicionales</h3>

<p>Estas configuraciones nos aseguran la conectividad entre los nodos y es importante realizar para el correcto funcionamiento del cluster.</p>

<h4>Configuración de hostnames (opcional)</h4>

<p>Si no contamos con un servicio de dominio (DNS) para poder asignarle a los servidores un dominio valido podemos usar la resolución por medio del archivo <em>/etc/hosts</em>.</p>

<pre><code># vim /etc/hosts
192.168.1.1 nodo1.example.com
192.168.1.2 nodo2.example.com
192.168.1.3 nodo3.example.com
</code></pre>

<blockquote>
  <p>Asegure de hacer la misma configuración para todos los nodos del cluster.</p>
</blockquote>

<h4>Inicio de sesión SSH private-key</h4>

<p>Esta configuración es indispensable, ya que los archivos base de <em>postgresql</em> se van ha sincronizar con la herramienta <em>rsync</em> y este utilizara este tipo de acceso con los nodos.</p>

<p>Siguiendo en el <em>nodo1</em> configuramos de las siguiente forma, iniciamos una sesión del usuario <strong><em>postgres</em></strong> y generamos sus llaves de acceso y lo agregamos entre las llaves autorizadas.</p>

<pre><code>$ su - postgres
$ ssh-keygen
$ cat ~/.ssh/id_rsa.pub &gt;&gt; ~/.ssh/authorized_keys
$ chmod 600 ~/.ssh/authorized_keys
$ exit
</code></pre>

<blockquote>
  <p>Cuando genere la llave no le asigne frase de acceso (passphrase).</p>
</blockquote>

<p>Ahora vamos a enviarle las llaves (publica y privada) y la lista de llaves autorizadas a todos los nodos que estarán en el cluster.</p>

<pre><code># rsync -avz ~postgres/.ssh/authorized_keys nodo2.example.com:~postgres/.ssh/
# rsync -avz ~postgres/.ssh/authorized_keys nodo3.example.com:~postgres/.ssh/

# rsync -avz ~postgres/.ssh/id_rsa* nodo2.example.com:~postgres/.ssh/
# rsync -avz ~postgres/.ssh/id_rsa* nodo3.example.com:~postgres/.ssh/
</code></pre>

<blockquote>
  <p>Note que las llaves enviadas son para el usuario <em>postgres</em>, este usuario es el que se va conectar a otros nodos usando ssh (rsync) sin requerir contraseña.</p>
</blockquote>

<h3>Registrando el nodo maestro</h3>

<p>Antes de registrar al nodo maestro necesitamos configurar la herramienta <em>REPMGR</em>.</p>

<pre><code># vi /etc/repmgr/9.2/repmgr.conf
cluster=mi_cluster
node=1
node_name=nodo1
conninfo='host=nodo1.example.com dbname=repmgr_db user=repmgr_usr'
logfile='/tmp/repmgr-9.2.log'
</code></pre>

<p>Ahora registramos el nodo maestro de la siguiente forma.</p>

<pre><code>$ /usr/pgsql-9.2/bin/repmgr -f /etc/repmgr/9.2/repmgr.conf master register --verbose
</code></pre>

<h3>Registrando nodos standby (esclavos)</h3>

<blockquote>
  <p>Estas configuraciones se realizan en cada servidor esclavo del cluster.</p>
</blockquote>

<p>Estando conectado en el nodo esclavo (nodo2) lo primero es clonar al nodo maestro (nodo1) y luego <em>REPMGR</em> se encargara de configurarlo como esclavo (recovery.conf).</p>

<pre><code>$ /usr/pgsql-9.2/bin/repmgr -d repmgr_db -U repmgr_usr standby clone nodo1.example.com --verbose
</code></pre>

<p>Iniciamos el servicio postgresql.</p>

<pre><code># service postgresql-9.2 start
</code></pre>

<p>Editamos la configuración de <em>REPMGR</em> (configuración del <strong>nodo2</strong>).</p>

<pre><code># vim /etc/repmgr/9.2/repmgr.conf
cluster=mi_cluster
node=2
node_name=nodo2
conninfo='host=nodo2.example.com dbname=repmgr_db user=repmgr_usr'
logfile='/tmp/repmgr-9.2.log'
</code></pre>

<p>Ahora registramos nuestro esclavo.</p>

<pre><code>$ /usr/pgsql-9.2/bin/repmgr -f /etc/repmgr/9.2/repmgr.conf standby register --verbose
</code></pre>

<p>Podemos verificamos el registro del nodo de la siguiente manera.</p>

<pre><code>$ /usr/pgsql-9.2/bin/repmgr -f /etc/repmgr/9.2/repmgr.conf cluster show
Role      | Connection String 
* master  | host=nodo1.example.com user=repmgr_usr dbname=repmgr_db
standby   | host=nodo2.example.com user=repmgr_usr dbname=repmgr_db
</code></pre>

<h2>Failover manual</h2>

<p>Ahora realizamos el siguiente ejercicio, haremos que el <em>nodo1</em> se detenga para promover al <em>nodo2</em> a maestro y después hacer que los demás nodos sigan al nuevo maestro (nodo 2).</p>

<h3>Promover al nodo2 a maestro</h3>

<p>Antes de promover este nodo detenemos el nodo maestro para simular la baja del servidor.</p>

<pre><code># poweroff
</code></pre>

<p>Ahora nos conectamos al <em>nodo2</em> y vamos a promoverlo como nodo maestro.</p>

<pre><code>$ su - postgres
$ /usr/pgsql-9.2/bin/repmgr -f /etc/repmgr/9.2/repmgr.conf --verbose standby promote
$ exit
# service postgresql-9.2 restart
</code></pre>

<h3>Reconfigurar los nodos para seguir al nuevo maestro</h3>

<p>Realizamos lo siguiente en cada <strong><em>nodo esclavo</em></strong> para que puedan seguir al nuevo nodo maestro.</p>

<pre><code>$ su - postgres
$ /usr/pgsql-9.2/bin/repmgr -f /etc/repmgr/9.2/repmgr.conf standby follow 
</code></pre>

<h3>Volver al nodo1 a esclavo</h3>

<p>Detener servicio postgresql, al iniciar el servidor maestro es posible que este inicie automáticamente.</p>

<pre><code># service postgresql-9.2 stop
</code></pre>

<p>Clonar a partir del nuevo maestro.</p>

<pre><code>$ su - postgres
$ /usr/pgsql-9.2/bin/repmgr -d repmgr_db -U repmgr_usr --verbose standby clone node2.example.com --ignore-rsync-warning --force
$ exit
</code></pre>

<p>Iniciamos el servicio</p>

<pre><code># service postgresql-9.2 start
</code></pre>

<h3>Tips extras</h3>

<p>Revisar el estado de replicación en nuestro servidor maestro</p>

<pre><code>$ su - postgres
$ psql -x -c "select * from pg_stat_replication;"
</code></pre>

<h2>Resolución de problemas</h2>

<ul><li>Host key verification failed. Error al clonar con el nodo maestro</li>
</ul><p>Es posible que sea la primera ves que intentas una conexión <strong><em>ssh</em></strong> con el servidor maestro.</p>

<pre><code>$ su - postgres
$ ssh nodo1.example.com
The authenticity of host 'nodo2.example.com (192.168.1.2)' can't be established.
RSA key fingerprint is xx:8e:2e:e9:d0:xx:5d:7b:48:d3:25:xx:18:50:b7:xx.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added 'nodo1.example.com' (RSA) to the list of known hosts.
Welcome to your server.
</code></pre>

  </div>

  
</article>

      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Tech Monkey</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              Tech Monkey
            
            </li>
            
            <li><a href="mailto:me@jahrmando.com">me@jahrmando.com</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/jahrmando"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">jahrmando</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/jahrmando"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">jahrmando</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>An Accidental Engineer • Tech Monkey • #Linux #DevOps #Programmer #Infosec
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
