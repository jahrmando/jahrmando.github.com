<!DOCTYPE html>
<html lang="es">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Instalación y configuración del servicio NGINX y PHP-FPM en CentOS 7 &middot; Tech Monkey
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/blackdoc.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=EB+Garamond">
  <link href="https://fonts.googleapis.com/css?family=Bree+Serif|Coustard" rel="stylesheet">
  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>


  <body>

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          Tech Monkey
        </a>
      </h1>
      <p class="lead">An Accidental Engineer • #Linux #DevOps #Programmer #Infosec</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">Acerca de</a>
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      

      <hr>
      <a class="sidebar-nav-item" href="https://github.com/jahrmando/blackdoc">Repositorios</a>
    </nav>

    <p>&copy; 2017. All rights reserved.</p>
  </div>
</div>


    <div class="content container">
      <div class="post">
  <h1 class="post-title">Instalación y configuración del servicio NGINX y PHP-FPM en CentOS 7</h1>
  <span class="post-date">11 Feb 2015</span>
  <p>Este manual nos permitira configurar un servicio <strong>HTTP</strong> usando <em>NGINX</em> y con soporte <strong>PHP</strong> usando <em>PHP-FPM</em>.</p>

<blockquote>
  <p>Las configuraciones presentadas funcionan bajo el esquema de seguridad <strong>SELINUX</strong>.</p>
</blockquote>

<p>Instalemos el servicio <em>NGINX</em> desde los reposotorios <em>EPEL</em>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ sudo yum install nginx --enablerepo epel
</code></pre>
</div>

<blockquote>
  <p>Si no tiene el repositorio <em>EPEL</em> configurado hagalo desde <a href="http://www.cyberciti.biz/faq/installing-rhel-epel-repo-on-centos-redhat-7-x/">aquí</a></p>
</blockquote>

<p>Ahora vamos a habilitar el servicio en el inicio de sistema con el comando <code class="highlighter-rouge">enable</code> y despues iniciamos el servicio (<code class="highlighter-rouge">start</code>).</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ sudo systemctl enable nginx.service
$ sudo systemctl start nginx.service
</code></pre>
</div>

<p>Por defecto <em>CentOS 7</em> trae el servicio <em>firewalld</em> como servicio de muro de fuego, <em>firewalld</em> maneja perfiles de servicio para habilitar puertos por lo cual vamos ha habilitar el perfil <strong><em>http</em></strong> que nos abre el puerto <em>80/TCP</em>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ sudo firewall-cmd --zone=public --add-service=http --permanent
$ sudo firewall-cmd --reload
</code></pre>
</div>

<p>Podemos ver el estatus del firewall usando el comando <code class="highlighter-rouge">firewall-cmd --list-all</code>.</p>

<h3 id="configuracin-de-nginx">Configuración de NGINX</h3>

<p>Ahora vamos a configurar el <em>NGINX</em>, primero creamos una carpeta llamada <em>sites-enabled</em> que sera el directorio donde <em>NGINX</em> cargará configuraciones.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ sudo mkdir /etc/nginx/sites-enabled
</code></pre>
</div>

<p>El esquema como buena practica, es que nosotros crearemos los archivos desde el directorio <strong><em>/etc/nginx/conf.d</em></strong> y “<em>activaremos</em>” la configuracion creando un acceso directo de la configuracion apuntando a <strong><em>/etc/nginx/sites-enabled</em></strong>.</p>

<p><em>Ejemplo</em>:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ ln -s /etc/nginx/conf.d/misitio.conf /etc/nginx/sites-enabled/misitio.conf
</code></pre>
</div>

<blockquote>
  <p>De esta manera nos es mas facil desactivar sitios sin borrar sus archivos de configuracion.</p>
</blockquote>

<p>Antes de iniciar la edicion del archivo principal de configuracion de <em>NGINX</em> respaldamos la configuracion inicial.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ sudo cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.old
</code></pre>
</div>

<p>Configuramos de la siguiente manera, siga las instruccion de los comentarios del archivo.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ sudo vim /etc/nginx/nginx.conf
user  nginx;
worker_processes  4;                        # Ajuste de acuerdo al numero de CPUs

#error_log  /var/log/nginx/error.log;
#error_log  /var/log/nginx/error.log  notice;
#error_log  /var/log/nginx/error.log  info;
error_log  /var/log/nginx/error.log  warn;  # Logs a nivel de advertencia

pid        /run/nginx.pid;

events {
    worker_connections  1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile    on;
    tcp_nopush  on;                         # Optimiza el rendimiento de sendfile
    keepalive_timeout  65;                      # Ajuste de tiempo de espera
    gzip  on;                                   # Reduce la cantidad de datos a transferir

    include /etc/nginx/sites-enabled/*.conf;    # Directorio de configuraciones
}
</code></pre>
</div>

<h3 id="configuracion-de-php-fpm-soporte-fastcgi-para-php">Configuracion de php-fpm (Soporte FastCGI para PHP)</h3>

<p>El servicio <a href="http://php-fpm.org">php-fpm</a> nos da el sorporte para sitios web hechos en <em>PHP</em>. Procedamos a instalar php-fpm y los modulos PHP necesarios para su funcion.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ sudo yum install php-fpm php-common php-cli php-pear php-pdo php-gd php-mbstring php-xml php-pecl-apc --enablerepo epel
</code></pre>
</div>

<p>Ahora editamos el archivo de configuracion de <em>php-fpm</em>. Configuraciones importantes en la variable <code class="highlighter-rouge">listen</code> donde declaramos el socket del servicio y las variables <code class="highlighter-rouge">user</code> y <code class="highlighter-rouge">group</code>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/php-fpm.d/www.conf
;listen = 127.0.0.1:9000
listen = /var/run/php5-fpm.sock

;user = apache
;group = apache
user = nginx
group = nginx

request_terminate_timeout = 65

security.limit_extensions = .php .php3 .php4 .php5
</code></pre>
</div>

<p>Creamos directorios indispensables para el servicio y le asignamos los permisos correspondientes.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ mkdir -p /var/lib/php/{session,tmp}
$ chmod 750 -R /var/lib/php/
$ chown nginx:nginx -R /var/lib/php/
</code></pre>
</div>

<p>Ahora agregamos el siguiente archivo, este contiene configuraciones de seguridad que he recopilado y que nos permite agregarle un extra de seguridad.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/php.d/security.ini
; Ocultar version de PHP
expose_php=Off
; Ocultar errores
display_errors=Off
; Bloquear subidas de archivos
;file_uploads=Off
; ó limitar los archivos a subir
file_uploads=On
upload_max_filesize=1M
; Bloquear ejecucion remota via ftp,http
allow_url_fopen=Off
allow_url_include=Off
; Desactivar (Obsoleto a partir de PHP 5.4.0)
magic_quotes_gpc=Off
; Limita los paquetes POST, (Default 8M)
post_max_size=1M
; Control de recursos
max_execution_time =  30
max_input_time = 30
memory_limit = 8M
; Desactivar funciones que podrían ser explotadas
disable_functions = exec,passthru,shell_exec,system,proc_open,popen,curl_multi_exec,parse_ini_file,show_source
; Directorio temporal
upload_tmp_dir = /var/lib/php/tmp/
; Limitar la ejecución a php en directorio
open_basedir = /home/www/
</code></pre>
</div>

<blockquote>
  <p>Para esta prueba no desabilitamos <strong>phpinfo</strong> en la variable <strong>disable_functions</strong> para poder realizar la prueba, recomiendo agregarlo una vez terminada las pruebas.
Estas opciones las puede ajustar a su criterio.</p>
</blockquote>

<p>Habilitamos el servicio en el inicio de sistema e iniciamos el servicio.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ systemctl enable php-fpm.service
$ systemctl start php-fpm.service
</code></pre>
</div>

<h3 id="configuracion-de-un-sitio-de-prueba">Configuracion de un sitio de prueba</h3>

<p>Lo primero que haremos es crear el archivo de configuracion de nuestro sitio en <em>NGINX</em> (recuerde que estas van en el directorio <em>/etc/nginx/conf.d</em>).</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /etc/nginx/conf.d/test.conf
server {
    listen       80 default;
    server_name  localhost;

    ## Deshabilitamos que imprima la version de NGINX ##
    server_tokens off;

    ## Registros del virtualhost ##
    access_log  /var/log/nginx/test.access.log;
    error_log  /var/log/nginx/test.error.log;

    ## Metodos validos ##
    if ($request_method !~ ^(GET|HEAD|POST)$ ) {
         return 444;
    }

    location / {
        ## Los index validos, entre ellos el .php
        index  index.html index.htm index.php;

        ## Directorio del sitio
        root  /home/www/test/public_html;

        ## Soporte PHP ##
        location ~ \.php$ {
                root            public_html;
                fastcgi_pass    unix:/var/run/php5-fpm.sock;    #Socket de php-fpm
                fastcgi_index   index.php;
                fastcgi_param   SCRIPT_FILENAME  /home/www/test/public_html$fastcgi_script_name;
                include         /etc/nginx/fastcgi_params;
        }

        ## Denegar accesos a archivos ocultos ##
        location ~ /\. { deny  all; }

        ## Bloquear logs de archivos estaticos ###
        location ~* \.(jpg|jpeg|gif|png|css|js|ico|xml)$ {
                access_log        off;
                log_not_found     off;
                expires           360d;
        }
    }
}
</code></pre>
</div>

<blockquote>
  <p>Usted puede ver que estamos declarando que los archivos de nuestro sitio estaran alojados en <strong><em>/home/www</em></strong>.</p>
</blockquote>

<p>Ahora lo que haremos es activar nuestra configuracion nginx de prueba, para esto creamos un enlace directo hacia <em>/etc/nginx/sites-enabled</em> que es donde se <em>NGINX</em> carga los archivos de configuracion (como lo declaramos anteriormente).</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ ln -s /etc/nginx/conf.d/test.conf /etc/nginx/sites-enabled/test.conf
</code></pre>
</div>

<p>Creamos el directorio donde alojaremos nuestros sitio</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ mkdir -p /home/www/test/public_html
</code></pre>
</div>

<p>Creamos un archivo <em>php</em> donde ejecutaremos la funcion <code class="highlighter-rouge">phpinfo()</code> para compobrar que este funcionando correctamente.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ vim /home/www/test/public_html/index.php
&lt;?php
        phpinfo();
?&gt;
</code></pre>
</div>

<p>Asignamos permisos adecuados.</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ chmod 750 -R /home/www
$ chown nginx:nginx -R /home/www
</code></pre>
</div>

<p>Permisos necesarios para <strong>SELinux</strong></p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ semanage fcontext -a -t httpd_sys_content_t "/home/www(.*)"
$ restorecon -R -v /home/www/
</code></pre>
</div>

<blockquote>
  <p>No olvide asignar los permisos que se mencionan anteriormente para cada proyecto <em>PHP</em> que configure.</p>
</blockquote>

<p>Reiniciamos el servicio para cargar todo</p>

<div class="highlighter-rouge"><pre class="highlight"><code>$ systemctl restart nginx.service
</code></pre>
</div>

</div>

<div class="related">
  <h2>Quizas te interese</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/2017/02/20/aplicaci%C3%B3n-de-parches-en-vmware-esxi-5x/">
            Aplicación de parches en VMware ESXi 5.x
            <small>20 Feb 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/12/09/clonaci%C3%B3n-y-migraci%C3%B3n-en-tiempo-real-live/">
            Clonación y migración en tiempo real de instancias virtuales Qemu/KVM
            <small>09 Dec 2015</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/2015/12/04/the-netflix-tech-blog-an%C3%A1lisis-del-rendimiento/">
            Análisis del rendimiento de Linux en 60 Segundos
            <small>04 Dec 2015</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>

  </body>
</html>
